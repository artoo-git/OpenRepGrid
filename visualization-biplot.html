<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Biplots</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">OpenRepGrid</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="news.html">News</a></li>
        <li><a href="installation.html">Installation</a></li>
        <li><a href="features.html">Features</a></li>
        <li><a href="data.html">Data</a></li>
        <li><a href="contribute.html">Contribute</a></li>
      </ul>
      
      <!-- Mailchimp signup page: http://eepurl.com/4h0t9 -->
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://eepurl.com/4h0t9" target="_blank"><span class="glyphicon glyphicon-envelope"></span> &nbsp;Newsletter</a></li>
      </ul>
    
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Biplots</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#biplot-functions">Biplot functions</a><ul>
<li><a href="#biplotsimple"><code>biplotSimple</code></a></li>
<li><a href="#biplot2d"><code>biplot2d</code></a></li>
<li><a href="#biplotpseudo3d"><code>biplotPseudo3d</code></a></li>
<li><a href="#biplot3d"><code>biplot3d</code></a></li>
</ul></li>
<li><a href="#pre-transformations">Pre-transformations</a></li>
<li><a href="#standard-biplot-types">Standard biplot types</a><ul>
<li><a href="#element-metric-preserving-biplot">Element metric preserving biplot</a></li>
<li><a href="#slaters-ingrid-biplot">Slater’s INGRID biplot</a></li>
<li><a href="#eigenstructure-analysis-esa-biplot">Eigenstructure analysis (ESA) biplot</a></li>
</ul></li>
<li><a href="#changing-the-appearance">Changing the appearance</a></li>
<li><a href="#calculation-of-biplots">Calculation of biplots</a></li>
<li><a href="#literature">Literature</a></li>
</ul>
</div>

<div id="description" class="section level3">
<h3>Description</h3>
<p>One of the most appealing features in the analysis of repertory grids is the joint spatial representation of elements and constructs, i. e. row and column points, in a single plot. These plots visualize inter-construct, inter-element and element-construct relations. They can be a helpful tool as they allow insights into the interviewee’s world, support the formulation of clinical hypotheses or and foster the client-therapist interaction.</p>
<p>The first composite plot of repertory grids was introduced by Slater (1964) in his INGRID program. Since its introduction, the INGRID composite plot has become a standard feature of contemporary grid software (e. g. Fransella, Bell &amp; Bannister, 2003).</p>
<p>In contemporary research literature, the joint spatial representation of two different aspects of a data matrix in one composite plot is often treated within the biplot framework (cf. Gower, Lubbe, Gardner, &amp; Roux, 2011; Greenacre, 2010). This framework comprises representations based on different multivariate techniques such as PCA, MDS, CA etc. These techniques differ with regard to several aspects (e.g. pre-treatment of the data, distance model) and yield spatial representations focusing on different aspects of the data. The central idea of a joint spatial representation, i.e. a biplot, is to render a visual representation (usually in two or three dimensions) that optimally displays central features inherent in the data (e.g. correlations between variables, distances between points). As the data represented usually has a dimensionality higher than two or three (i.e. the rank of its data matrix) the problem arises of how to optimally represent the data within a space of lower dimensionality. Hence, the visual representation requires a dimensionality reduction that is usually achieved by a factorization of the data matrix called singular value decomposition (SVD). As the biplot representation is central to grid representation, its rationale will be briefly outlined.</p>
</div>
<div id="biplot-functions" class="section level3">
<h3>Biplot functions</h3>
<p>In <code>OpenRepGrid</code> a number of functions have been implemented to produce different types of biplots. The following are the most important ones:</p>
<ul>
<li><code>biplotSimple</code></li>
<li><code>biplot2d</code></li>
<li><code>biplotPeudo3d</code></li>
<li><code>biplot3d</code></li>
</ul>
<p>All of these functions allow to change a lot of their settings. To see the whole list of available arguments type <code>?</code> followed by the function name.</p>
<div id="biplotsimple" class="section level4">
<h4><code>biplotSimple</code></h4>
<p><code>biplotSimple</code> is a graphically unsophisticated version of a biplot. It will draw elements and constructs vectors using similar arguments as <code>biplot2d</code>. It is a version for quick exploration used during development. The colors of the constructs has been set to <code>darkred</code> to make it easier to differentiate between constructs and element labels.</p>
<pre class="r"><code>biplotSimple(boeker, c.label.col=&quot;darkred&quot;)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biplot-simple-1.png" width="672" /></p>
</div>
<div id="biplot2d" class="section level4">
<h4><code>biplot2d</code></h4>
<p>Draws a two-dimensional biplot with a more sophisticated look. Depending on the parameters chosen it contains information on the distances between elements and constructs. Also the relative values the elements have on a construct can be read off by projetion the element onto the construct vector. A lot of parameters can be changed rendering different types of biplots (ESA, Slater’s) and different looks (colors, text size).</p>
<pre class="r"><code>biplot2d(boeker)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biplot2d-1.png" width="672" /></p>
</div>
<div id="biplotpseudo3d" class="section level4">
<h4><code>biplotPseudo3d</code></h4>
<p>Draws a biplot of the grid in 2D with depth impression (pseudo 3D). This version is basically a 2D biplot. It only modifies the color and size of the symbols in order to create a 3D impression of the data points. Lighter and smaller labels are more to the back, darker and bigger labels more to the front. This function will call the standard biplot2d function with some modified arguments. For the whole set of arguments that can be used see <code>?biplot2d</code>.</p>
<pre class="r"><code>biplotPseudo3d(boeker)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biploPseudo3d-1.png" width="672" /></p>
</div>
<div id="biplot3d" class="section level4">
<h4><code>biplot3d</code></h4>
<p>Renders an interactive 3D biplot. You will only see the interactive 3D plot below if your browser supports WebGL (like e.g. Google Chrome).</p>
<pre class="r"><code>biplot3d(boeker)</code></pre>
<script>/*
* Copyright (C) 2009 Apple Inc. All Rights Reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions
* are met:
* 1. Redistributions of source code must retain the above copyright
*    notice, this list of conditions and the following disclaimer.
* 2. Redistributions in binary form must reproduce the above copyright
*    notice, this list of conditions and the following disclaimer in the
*    documentation and/or other materials provided with the distribution.
*
* THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
* EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
* PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
* CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
* PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
* PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
* OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
* OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
* Copyright (2016) Duncan Murdoch - fixed CanvasMatrix4.ortho,
* cleaned up.
*/
/*
CanvasMatrix4 class
This class implements a 4x4 matrix. It has functions which
duplicate the functionality of the OpenGL matrix stack and
glut functions.
IDL:
[
Constructor(in CanvasMatrix4 matrix),           // copy passed matrix into new CanvasMatrix4
Constructor(in sequence<float> array)           // create new CanvasMatrix4 with 16 floats (row major)
Constructor()                                   // create new CanvasMatrix4 with identity matrix
]
interface CanvasMatrix4 {
attribute float m11;
attribute float m12;
attribute float m13;
attribute float m14;
attribute float m21;
attribute float m22;
attribute float m23;
attribute float m24;
attribute float m31;
attribute float m32;
attribute float m33;
attribute float m34;
attribute float m41;
attribute float m42;
attribute float m43;
attribute float m44;
void load(in CanvasMatrix4 matrix);                 // copy the values from the passed matrix
void load(in sequence<float> array);                // copy 16 floats into the matrix
sequence<float> getAsArray();                       // return the matrix as an array of 16 floats
WebGLFloatArray getAsCanvasFloatArray();           // return the matrix as a WebGLFloatArray with 16 values
void makeIdentity();                                // replace the matrix with identity
void transpose();                                   // replace the matrix with its transpose
void invert();                                      // replace the matrix with its inverse
void translate(in float x, in float y, in float z); // multiply the matrix by passed translation values on the right
void scale(in float x, in float y, in float z);     // multiply the matrix by passed scale values on the right
void rotate(in float angle,                         // multiply the matrix by passed rotation values on the right
in float x, in float y, in float z);    // (angle is in degrees)
void multRight(in CanvasMatrix matrix);             // multiply the matrix by the passed matrix on the right
void multLeft(in CanvasMatrix matrix);              // multiply the matrix by the passed matrix on the left
void ortho(in float left, in float right,           // multiply the matrix by the passed ortho values on the right
in float bottom, in float top,
in float near, in float far);
void frustum(in float left, in float right,         // multiply the matrix by the passed frustum values on the right
in float bottom, in float top,
in float near, in float far);
void perspective(in float fovy, in float aspect,    // multiply the matrix by the passed perspective values on the right
in float zNear, in float zFar);
void lookat(in float eyex, in float eyey, in float eyez,    // multiply the matrix by the passed lookat
in float ctrx, in float ctry, in float ctrz,    // values on the right
in float upx, in float upy, in float upz);
}
*/
CanvasMatrix4 = function(m)
{
if (typeof m == 'object') {
if ("length" in m && m.length >= 16) {
this.load(m[0], m[1], m[2], m[3], m[4], m[5], m[6], m[7], m[8], m[9], m[10], m[11], m[12], m[13], m[14], m[15]);
return;
}
else if (m instanceof CanvasMatrix4) {
this.load(m);
return;
}
}
this.makeIdentity();
};
CanvasMatrix4.prototype.load = function()
{
if (arguments.length == 1 && typeof arguments[0] == 'object') {
var matrix = arguments[0];
if ("length" in matrix && matrix.length == 16) {
this.m11 = matrix[0];
this.m12 = matrix[1];
this.m13 = matrix[2];
this.m14 = matrix[3];
this.m21 = matrix[4];
this.m22 = matrix[5];
this.m23 = matrix[6];
this.m24 = matrix[7];
this.m31 = matrix[8];
this.m32 = matrix[9];
this.m33 = matrix[10];
this.m34 = matrix[11];
this.m41 = matrix[12];
this.m42 = matrix[13];
this.m43 = matrix[14];
this.m44 = matrix[15];
return;
}
if (arguments[0] instanceof CanvasMatrix4) {
this.m11 = matrix.m11;
this.m12 = matrix.m12;
this.m13 = matrix.m13;
this.m14 = matrix.m14;
this.m21 = matrix.m21;
this.m22 = matrix.m22;
this.m23 = matrix.m23;
this.m24 = matrix.m24;
this.m31 = matrix.m31;
this.m32 = matrix.m32;
this.m33 = matrix.m33;
this.m34 = matrix.m34;
this.m41 = matrix.m41;
this.m42 = matrix.m42;
this.m43 = matrix.m43;
this.m44 = matrix.m44;
return;
}
}
this.makeIdentity();
};
CanvasMatrix4.prototype.getAsArray = function()
{
return [
this.m11, this.m12, this.m13, this.m14,
this.m21, this.m22, this.m23, this.m24,
this.m31, this.m32, this.m33, this.m34,
this.m41, this.m42, this.m43, this.m44
];
};
CanvasMatrix4.prototype.getAsWebGLFloatArray = function()
{
return new WebGLFloatArray(this.getAsArray());
};
CanvasMatrix4.prototype.makeIdentity = function()
{
this.m11 = 1;
this.m12 = 0;
this.m13 = 0;
this.m14 = 0;
this.m21 = 0;
this.m22 = 1;
this.m23 = 0;
this.m24 = 0;
this.m31 = 0;
this.m32 = 0;
this.m33 = 1;
this.m34 = 0;
this.m41 = 0;
this.m42 = 0;
this.m43 = 0;
this.m44 = 1;
};
CanvasMatrix4.prototype.transpose = function()
{
var tmp = this.m12;
this.m12 = this.m21;
this.m21 = tmp;
tmp = this.m13;
this.m13 = this.m31;
this.m31 = tmp;
tmp = this.m14;
this.m14 = this.m41;
this.m41 = tmp;
tmp = this.m23;
this.m23 = this.m32;
this.m32 = tmp;
tmp = this.m24;
this.m24 = this.m42;
this.m42 = tmp;
tmp = this.m34;
this.m34 = this.m43;
this.m43 = tmp;
};
CanvasMatrix4.prototype.invert = function()
{
// Calculate the 4x4 determinant
// If the determinant is zero,
// then the inverse matrix is not unique.
var det = this._determinant4x4();
if (Math.abs(det) < 1e-8)
return null;
this._makeAdjoint();
// Scale the adjoint matrix to get the inverse
this.m11 /= det;
this.m12 /= det;
this.m13 /= det;
this.m14 /= det;
this.m21 /= det;
this.m22 /= det;
this.m23 /= det;
this.m24 /= det;
this.m31 /= det;
this.m32 /= det;
this.m33 /= det;
this.m34 /= det;
this.m41 /= det;
this.m42 /= det;
this.m43 /= det;
this.m44 /= det;
};
CanvasMatrix4.prototype.translate = function(x,y,z)
{
if (x === undefined)
x = 0;
if (y === undefined)
y = 0;
if (z === undefined)
z = 0;
var matrix = new CanvasMatrix4();
matrix.m41 = x;
matrix.m42 = y;
matrix.m43 = z;
this.multRight(matrix);
};
CanvasMatrix4.prototype.scale = function(x,y,z)
{
if (x === undefined)
x = 1;
if (z === undefined) {
if (y === undefined) {
y = x;
z = x;
}
else
z = 1;
}
else if (y === undefined)
y = x;
var matrix = new CanvasMatrix4();
matrix.m11 = x;
matrix.m22 = y;
matrix.m33 = z;
this.multRight(matrix);
};
CanvasMatrix4.prototype.rotate = function(angle,x,y,z)
{
// angles are in degrees. Switch to radians
angle = angle / 180 * Math.PI;
angle /= 2;
var sinA = Math.sin(angle);
var cosA = Math.cos(angle);
var sinA2 = sinA * sinA;
// normalize
var length = Math.sqrt(x * x + y * y + z * z);
if (length === 0) {
// bad vector, just use something reasonable
x = 0;
y = 0;
z = 1;
} else if (length != 1) {
x /= length;
y /= length;
z /= length;
}
var mat = new CanvasMatrix4();
// optimize case where axis is along major axis
if (x == 1 && y === 0 && z === 0) {
mat.m11 = 1;
mat.m12 = 0;
mat.m13 = 0;
mat.m21 = 0;
mat.m22 = 1 - 2 * sinA2;
mat.m23 = 2 * sinA * cosA;
mat.m31 = 0;
mat.m32 = -2 * sinA * cosA;
mat.m33 = 1 - 2 * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else if (x === 0 && y == 1 && z === 0) {
mat.m11 = 1 - 2 * sinA2;
mat.m12 = 0;
mat.m13 = -2 * sinA * cosA;
mat.m21 = 0;
mat.m22 = 1;
mat.m23 = 0;
mat.m31 = 2 * sinA * cosA;
mat.m32 = 0;
mat.m33 = 1 - 2 * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else if (x === 0 && y === 0 && z == 1) {
mat.m11 = 1 - 2 * sinA2;
mat.m12 = 2 * sinA * cosA;
mat.m13 = 0;
mat.m21 = -2 * sinA * cosA;
mat.m22 = 1 - 2 * sinA2;
mat.m23 = 0;
mat.m31 = 0;
mat.m32 = 0;
mat.m33 = 1;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
} else {
var x2 = x*x;
var y2 = y*y;
var z2 = z*z;
mat.m11 = 1 - 2 * (y2 + z2) * sinA2;
mat.m12 = 2 * (x * y * sinA2 + z * sinA * cosA);
mat.m13 = 2 * (x * z * sinA2 - y * sinA * cosA);
mat.m21 = 2 * (y * x * sinA2 - z * sinA * cosA);
mat.m22 = 1 - 2 * (z2 + x2) * sinA2;
mat.m23 = 2 * (y * z * sinA2 + x * sinA * cosA);
mat.m31 = 2 * (z * x * sinA2 + y * sinA * cosA);
mat.m32 = 2 * (z * y * sinA2 - x * sinA * cosA);
mat.m33 = 1 - 2 * (x2 + y2) * sinA2;
mat.m14 = mat.m24 = mat.m34 = 0;
mat.m41 = mat.m42 = mat.m43 = 0;
mat.m44 = 1;
}
this.multRight(mat);
};
CanvasMatrix4.prototype.multRight = function(mat)
{
var m11 = (this.m11 * mat.m11 + this.m12 * mat.m21 +
this.m13 * mat.m31 + this.m14 * mat.m41);
var m12 = (this.m11 * mat.m12 + this.m12 * mat.m22 +
this.m13 * mat.m32 + this.m14 * mat.m42);
var m13 = (this.m11 * mat.m13 + this.m12 * mat.m23 +
this.m13 * mat.m33 + this.m14 * mat.m43);
var m14 = (this.m11 * mat.m14 + this.m12 * mat.m24 +
this.m13 * mat.m34 + this.m14 * mat.m44);
var m21 = (this.m21 * mat.m11 + this.m22 * mat.m21 +
this.m23 * mat.m31 + this.m24 * mat.m41);
var m22 = (this.m21 * mat.m12 + this.m22 * mat.m22 +
this.m23 * mat.m32 + this.m24 * mat.m42);
var m23 = (this.m21 * mat.m13 + this.m22 * mat.m23 +
this.m23 * mat.m33 + this.m24 * mat.m43);
var m24 = (this.m21 * mat.m14 + this.m22 * mat.m24 +
this.m23 * mat.m34 + this.m24 * mat.m44);
var m31 = (this.m31 * mat.m11 + this.m32 * mat.m21 +
this.m33 * mat.m31 + this.m34 * mat.m41);
var m32 = (this.m31 * mat.m12 + this.m32 * mat.m22 +
this.m33 * mat.m32 + this.m34 * mat.m42);
var m33 = (this.m31 * mat.m13 + this.m32 * mat.m23 +
this.m33 * mat.m33 + this.m34 * mat.m43);
var m34 = (this.m31 * mat.m14 + this.m32 * mat.m24 +
this.m33 * mat.m34 + this.m34 * mat.m44);
var m41 = (this.m41 * mat.m11 + this.m42 * mat.m21 +
this.m43 * mat.m31 + this.m44 * mat.m41);
var m42 = (this.m41 * mat.m12 + this.m42 * mat.m22 +
this.m43 * mat.m32 + this.m44 * mat.m42);
var m43 = (this.m41 * mat.m13 + this.m42 * mat.m23 +
this.m43 * mat.m33 + this.m44 * mat.m43);
var m44 = (this.m41 * mat.m14 + this.m42 * mat.m24 +
this.m43 * mat.m34 + this.m44 * mat.m44);
this.m11 = m11;
this.m12 = m12;
this.m13 = m13;
this.m14 = m14;
this.m21 = m21;
this.m22 = m22;
this.m23 = m23;
this.m24 = m24;
this.m31 = m31;
this.m32 = m32;
this.m33 = m33;
this.m34 = m34;
this.m41 = m41;
this.m42 = m42;
this.m43 = m43;
this.m44 = m44;
};
CanvasMatrix4.prototype.multLeft = function(mat)
{
var m11 = (mat.m11 * this.m11 + mat.m12 * this.m21 +
mat.m13 * this.m31 + mat.m14 * this.m41);
var m12 = (mat.m11 * this.m12 + mat.m12 * this.m22 +
mat.m13 * this.m32 + mat.m14 * this.m42);
var m13 = (mat.m11 * this.m13 + mat.m12 * this.m23 +
mat.m13 * this.m33 + mat.m14 * this.m43);
var m14 = (mat.m11 * this.m14 + mat.m12 * this.m24 +
mat.m13 * this.m34 + mat.m14 * this.m44);
var m21 = (mat.m21 * this.m11 + mat.m22 * this.m21 +
mat.m23 * this.m31 + mat.m24 * this.m41);
var m22 = (mat.m21 * this.m12 + mat.m22 * this.m22 +
mat.m23 * this.m32 + mat.m24 * this.m42);
var m23 = (mat.m21 * this.m13 + mat.m22 * this.m23 +
mat.m23 * this.m33 + mat.m24 * this.m43);
var m24 = (mat.m21 * this.m14 + mat.m22 * this.m24 +
mat.m23 * this.m34 + mat.m24 * this.m44);
var m31 = (mat.m31 * this.m11 + mat.m32 * this.m21 +
mat.m33 * this.m31 + mat.m34 * this.m41);
var m32 = (mat.m31 * this.m12 + mat.m32 * this.m22 +
mat.m33 * this.m32 + mat.m34 * this.m42);
var m33 = (mat.m31 * this.m13 + mat.m32 * this.m23 +
mat.m33 * this.m33 + mat.m34 * this.m43);
var m34 = (mat.m31 * this.m14 + mat.m32 * this.m24 +
mat.m33 * this.m34 + mat.m34 * this.m44);
var m41 = (mat.m41 * this.m11 + mat.m42 * this.m21 +
mat.m43 * this.m31 + mat.m44 * this.m41);
var m42 = (mat.m41 * this.m12 + mat.m42 * this.m22 +
mat.m43 * this.m32 + mat.m44 * this.m42);
var m43 = (mat.m41 * this.m13 + mat.m42 * this.m23 +
mat.m43 * this.m33 + mat.m44 * this.m43);
var m44 = (mat.m41 * this.m14 + mat.m42 * this.m24 +
mat.m43 * this.m34 + mat.m44 * this.m44);
this.m11 = m11;
this.m12 = m12;
this.m13 = m13;
this.m14 = m14;
this.m21 = m21;
this.m22 = m22;
this.m23 = m23;
this.m24 = m24;
this.m31 = m31;
this.m32 = m32;
this.m33 = m33;
this.m34 = m34;
this.m41 = m41;
this.m42 = m42;
this.m43 = m43;
this.m44 = m44;
};
CanvasMatrix4.prototype.ortho = function(left, right, bottom, top, near, far)
{
var tx = (left + right) / (left - right);
var ty = (top + bottom) / (bottom - top);
var tz = (far + near) / (near - far);
var matrix = new CanvasMatrix4();
matrix.m11 = 2 / (right - left);
matrix.m12 = 0;
matrix.m13 = 0;
matrix.m14 = 0;
matrix.m21 = 0;
matrix.m22 = 2 / (top - bottom);
matrix.m23 = 0;
matrix.m24 = 0;
matrix.m31 = 0;
matrix.m32 = 0;
matrix.m33 = -2 / (far - near);
matrix.m34 = 0;
matrix.m41 = tx;
matrix.m42 = ty;
matrix.m43 = tz;
matrix.m44 = 1;
this.multRight(matrix);
};
CanvasMatrix4.prototype.frustum = function(left, right, bottom, top, near, far)
{
var matrix = new CanvasMatrix4();
var A = (right + left) / (right - left);
var B = (top + bottom) / (top - bottom);
var C = -(far + near) / (far - near);
var D = -(2 * far * near) / (far - near);
matrix.m11 = (2 * near) / (right - left);
matrix.m12 = 0;
matrix.m13 = 0;
matrix.m14 = 0;
matrix.m21 = 0;
matrix.m22 = 2 * near / (top - bottom);
matrix.m23 = 0;
matrix.m24 = 0;
matrix.m31 = A;
matrix.m32 = B;
matrix.m33 = C;
matrix.m34 = -1;
matrix.m41 = 0;
matrix.m42 = 0;
matrix.m43 = D;
matrix.m44 = 0;
this.multRight(matrix);
};
CanvasMatrix4.prototype.perspective = function(fovy, aspect, zNear, zFar)
{
var top = Math.tan(fovy * Math.PI / 360) * zNear;
var bottom = -top;
var left = aspect * bottom;
var right = aspect * top;
this.frustum(left, right, bottom, top, zNear, zFar);
};
CanvasMatrix4.prototype.lookat = function(eyex, eyey, eyez, centerx, centery, centerz, upx, upy, upz)
{
var matrix = new CanvasMatrix4();
// Make rotation matrix
// Z vector
var zx = eyex - centerx;
var zy = eyey - centery;
var zz = eyez - centerz;
var mag = Math.sqrt(zx * zx + zy * zy + zz * zz);
if (mag) {
zx /= mag;
zy /= mag;
zz /= mag;
}
// Y vector
var yx = upx;
var yy = upy;
var yz = upz;
// X vector = Y cross Z
xx =  yy * zz - yz * zy;
xy = -yx * zz + yz * zx;
xz =  yx * zy - yy * zx;
// Recompute Y = Z cross X
yx = zy * xz - zz * xy;
yy = -zx * xz + zz * xx;
yx = zx * xy - zy * xx;
// cross product gives area of parallelogram, which is < 1.0 for
// non-perpendicular unit-length vectors; so normalize x, y here
mag = Math.sqrt(xx * xx + xy * xy + xz * xz);
if (mag) {
xx /= mag;
xy /= mag;
xz /= mag;
}
mag = Math.sqrt(yx * yx + yy * yy + yz * yz);
if (mag) {
yx /= mag;
yy /= mag;
yz /= mag;
}
matrix.m11 = xx;
matrix.m12 = xy;
matrix.m13 = xz;
matrix.m14 = 0;
matrix.m21 = yx;
matrix.m22 = yy;
matrix.m23 = yz;
matrix.m24 = 0;
matrix.m31 = zx;
matrix.m32 = zy;
matrix.m33 = zz;
matrix.m34 = 0;
matrix.m41 = 0;
matrix.m42 = 0;
matrix.m43 = 0;
matrix.m44 = 1;
matrix.translate(-eyex, -eyey, -eyez);
this.multRight(matrix);
};
// Support functions
CanvasMatrix4.prototype._determinant2x2 = function(a, b, c, d)
{
return a * d - b * c;
};
CanvasMatrix4.prototype._determinant3x3 = function(a1, a2, a3, b1, b2, b3, c1, c2, c3)
{
return a1 * this._determinant2x2(b2, b3, c2, c3) -
b1 * this._determinant2x2(a2, a3, c2, c3) +
c1 * this._determinant2x2(a2, a3, b2, b3);
};
CanvasMatrix4.prototype._determinant4x4 = function()
{
var a1 = this.m11;
var b1 = this.m12;
var c1 = this.m13;
var d1 = this.m14;
var a2 = this.m21;
var b2 = this.m22;
var c2 = this.m23;
var d2 = this.m24;
var a3 = this.m31;
var b3 = this.m32;
var c3 = this.m33;
var d3 = this.m34;
var a4 = this.m41;
var b4 = this.m42;
var c4 = this.m43;
var d4 = this.m44;
return a1 * this._determinant3x3(b2, b3, b4, c2, c3, c4, d2, d3, d4) -
b1 * this._determinant3x3(a2, a3, a4, c2, c3, c4, d2, d3, d4) +
c1 * this._determinant3x3(a2, a3, a4, b2, b3, b4, d2, d3, d4) -
d1 * this._determinant3x3(a2, a3, a4, b2, b3, b4, c2, c3, c4);
};
CanvasMatrix4.prototype._makeAdjoint = function()
{
var a1 = this.m11;
var b1 = this.m12;
var c1 = this.m13;
var d1 = this.m14;
var a2 = this.m21;
var b2 = this.m22;
var c2 = this.m23;
var d2 = this.m24;
var a3 = this.m31;
var b3 = this.m32;
var c3 = this.m33;
var d3 = this.m34;
var a4 = this.m41;
var b4 = this.m42;
var c4 = this.m43;
var d4 = this.m44;
// Row column labeling reversed since we transpose rows & columns
this.m11  =   this._determinant3x3(b2, b3, b4, c2, c3, c4, d2, d3, d4);
this.m21  = - this._determinant3x3(a2, a3, a4, c2, c3, c4, d2, d3, d4);
this.m31  =   this._determinant3x3(a2, a3, a4, b2, b3, b4, d2, d3, d4);
this.m41  = - this._determinant3x3(a2, a3, a4, b2, b3, b4, c2, c3, c4);
this.m12  = - this._determinant3x3(b1, b3, b4, c1, c3, c4, d1, d3, d4);
this.m22  =   this._determinant3x3(a1, a3, a4, c1, c3, c4, d1, d3, d4);
this.m32  = - this._determinant3x3(a1, a3, a4, b1, b3, b4, d1, d3, d4);
this.m42  =   this._determinant3x3(a1, a3, a4, b1, b3, b4, c1, c3, c4);
this.m13  =   this._determinant3x3(b1, b2, b4, c1, c2, c4, d1, d2, d4);
this.m23  = - this._determinant3x3(a1, a2, a4, c1, c2, c4, d1, d2, d4);
this.m33  =   this._determinant3x3(a1, a2, a4, b1, b2, b4, d1, d2, d4);
this.m43  = - this._determinant3x3(a1, a2, a4, b1, b2, b4, c1, c2, c4);
this.m14  = - this._determinant3x3(b1, b2, b3, c1, c2, c3, d1, d2, d3);
this.m24  =   this._determinant3x3(a1, a2, a3, c1, c2, c3, d1, d2, d3);
this.m34  = - this._determinant3x3(a1, a2, a3, b1, b2, b3, d1, d2, d3);
this.m44  =   this._determinant3x3(a1, a2, a3, b1, b2, b3, c1, c2, c3);
};</script>
<script>
rglwidgetClass = function() {
this.canvas = null;
this.userMatrix = new CanvasMatrix4();
this.types = [];
this.prMatrix = new CanvasMatrix4();
this.mvMatrix = new CanvasMatrix4();
this.vp = null;
this.prmvMatrix = null;
this.origs = null;
this.gl = null;
this.scene = null;
};
(function() {
this.multMV = function(M, v) {
return [ M.m11 * v[0] + M.m12 * v[1] + M.m13 * v[2] + M.m14 * v[3],
M.m21 * v[0] + M.m22 * v[1] + M.m23 * v[2] + M.m24 * v[3],
M.m31 * v[0] + M.m32 * v[1] + M.m33 * v[2] + M.m34 * v[3],
M.m41 * v[0] + M.m42 * v[1] + M.m43 * v[2] + M.m44 * v[3]
];
};
this.vlen = function(v) {
return Math.sqrt(this.dotprod(v, v));
};
this.dotprod = function(a, b) {
return a[0]*b[0] + a[1]*b[1] + a[2]*b[2];
};
this.xprod = function(a, b) {
return [a[1]*b[2] - a[2]*b[1],
a[2]*b[0] - a[0]*b[2],
a[0]*b[1] - a[1]*b[0]];
};
this.cbind = function(a, b) {
return a.map(function(currentValue, index, array) {
return currentValue.concat(b[index]);
});
};
this.swap = function(a, i, j) {
var temp = a[i];
a[i] = a[j];
a[j] = temp;
};
this.flatten = function(a) {
return [].concat.apply([], a);
};
/* set element of 1d or 2d array as if it was flattened.  Column major, zero based! */
this.setElement = function(a, i, value) {
if (Array.isArray(a[0])) {
var dim = a.length,
col = Math.floor(i/dim),
row = i % dim;
a[row][col] = value;
} else {
a[i] = value;
}
};
this.transpose = function(a) {
var newArray = [],
n = a.length,
m = a[0].length,
i;
for(i = 0; i < m; i++){
newArray.push([]);
}
for(i = 0; i < n; i++){
for(var j = 0; j < m; j++){
newArray[j].push(a[i][j]);
}
}
return newArray;
};
this.sumsq = function(x) {
var result = 0, i;
for (i=0; i < x.length; i++)
result += x[i]*x[i];
return result;
};
this.toCanvasMatrix4 = function(mat) {
if (mat instanceof CanvasMatrix4)
return mat;
var result = new CanvasMatrix4();
mat = this.flatten(this.transpose(mat));
result.load(mat);
return result;
};
this.stringToRgb = function(s) {
s = s.replace("#", "");
var bigint = parseInt(s, 16);
return [((bigint >> 16) & 255)/255,
((bigint >> 8) & 255)/255,
(bigint & 255)/255];
};
this.componentProduct = function(x, y) {
if (typeof y === "undefined") {
this.alertOnce("Bad arg to componentProduct");
}
var result = new Float32Array(3), i;
for (i = 0; i<3; i++)
result[i] = x[i]*y[i];
return result;
};
this.getPowerOfTwo = function(value) {
var pow = 1;
while(pow<value) {
pow *= 2;
}
return pow;
};
this.unique = function(arr) {
arr = [].concat(arr);
return arr.filter(function(value, index, self) {
return self.indexOf(value) === index;
});
};
this.repeatToLen = function(arr, len) {
arr = [].concat(arr);
while (arr.length < len/2)
arr = arr.concat(arr);
return arr.concat(arr.slice(0, len - arr.length));
};
this.alertOnce = function(msg) {
if (typeof this.alerted !== "undefined")
return;
this.alerted = true;
alert(msg);
};
this.f_is_lit = 1;
this.f_is_smooth = 2;
this.f_has_texture = 4;
this.f_is_indexed = 8;
this.f_depth_sort = 16;
this.f_fixed_quads = 32;
this.f_is_transparent = 64;
this.f_is_lines = 128;
this.f_sprites_3d = 256;
this.f_sprite_3d = 512;
this.f_is_subscene = 1024;
this.f_is_clipplanes = 2048;
this.whichList = function(id) {
var obj = this.getObj(id),
flags = obj.flags;
if (obj.type === "light")
return "lights";
if (flags & this.f_is_subscene)
return "subscenes";
if (flags & this.f_is_clipplanes)
return "clipplanes";
if (flags & this.f_is_transparent)
return "transparent";
return "opaque";
};
this.getObj = function(id) {
if (typeof id !== "number") {
this.alertOnce("getObj id is "+typeof id);
}
return this.scene.objects[id];
};
this.getIdsByType = function(type, subscene) {
var
result = [], i, self = this;
if (typeof subscene === "undefined") {
Object.keys(this.scene.objects).forEach(
function(key) {
key = parseInt(key, 10);
if (self.getObj(key).type === type)
result.push(key);
});
} else {
ids = this.getObj(subscene).objects;
for (i=0; i < ids.length; i++) {
if (this.getObj(ids[i]).type === type) {
result.push(ids[i]);
}
}
}
return result;
};
this.getMaterial = function(id, property) {
var obj = this.getObj(id),
mat = obj.material[property];
if (typeof mat === "undefined")
mat = this.scene.material[property];
return mat;
};
this.inSubscene = function(id, subscene) {
return this.getObj(subscene).objects.indexOf(id) > -1;
};
this.addToSubscene = function(id, subscene) {
var thelist,
thesub = this.getObj(subscene),
ids = [id],
obj = this.getObj(id), i;
if (typeof obj.newIds !== "undefined") {
ids = ids.concat(obj.newIds);
}
for (i = 0; i < ids.length; i++) {
id = ids[i];
if (thesub.objects.indexOf(id) == -1) {
thelist = this.whichList(id);
thesub.objects.push(id);
thesub[thelist].push(id);
}
}
};
this.delFromSubscene = function(id, subscene) {
var thelist,
thesub = this.getObj(subscene),
obj = this.getObj(id),
ids = [id], i;
if (typeof obj.newIds !== "undefined")
ids = ids.concat(obj.newIds);
for (j=0; j<ids.length;j++) {
id = ids[j];
i = thesub.objects.indexOf(id);
if (i > -1) {
thesub.objects.splice(i, 1);
thelist = this.whichList(id);
i = thesub[thelist].indexOf(id);
thesub[thelist].splice(i, 1);
}
}
};
this.setSubsceneEntries = function(ids, subsceneid) {
var sub = this.getObj(subsceneid);
sub.objects = ids;
this.initSubscene(subsceneid);
};
this.getSubsceneEntries = function(subscene) {
return this.getObj(subscene).objects;
};
this.getChildSubscenes = function(subscene) {
return this.getObj(subscene).subscenes;
};
this.startDrawing = function() {
var value = this.drawing;
this.drawing = true;
return value;
}
this.stopDrawing = function(saved) {
this.drawing = saved;
if (!saved && this.gl && this.gl.isContextLost())
this.restartCanvas();
}
this.getVertexShader = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
nclipplanes = this.countClipplanes(),
result;
if (type === "clipplanes" || sprites_3d) return;
result = "  /* ****** "+type+" object "+id+" vertex shader ****** */\n"+
"  attribute vec3 aPos;\n"+
"  attribute vec4 aCol;\n"+
" uniform mat4 mvMatrix;\n"+
" uniform mat4 prMatrix;\n"+
" varying vec4 vCol;\n"+
" varying vec4 vPosition;\n";
if ((is_lit && !fixed_quads) || sprite_3d)
result = result + "  attribute vec3 aNorm;\n"+
" uniform mat4 normMatrix;\n"+
" varying vec3 vNormal;\n";
if (has_texture || type === "text")
result = result + " attribute vec2 aTexcoord;\n"+
" varying vec2 vTexcoord;\n";
if (type === "text")
result = result + "  uniform vec2 textScale;\n";
if (fixed_quads)
result = result + "  attribute vec2 aOfs;\n";
else if (sprite_3d)
result = result + "  uniform vec3 uOrig;\n"+
" uniform float uSize;\n"+
" uniform mat4 usermat;\n";
result = result + "  void main(void) {\n";
if (nclipplanes || (!fixed_quads && !sprite_3d))
result = result + "    vPosition = mvMatrix * vec4(aPos, 1.);\n";
if (!fixed_quads && !sprite_3d)
result = result + "    gl_Position = prMatrix * vPosition;\n";
if (type == "points") {
var size = this.getMaterial(id, "size");
result = result + "    gl_PointSize = "+size.toFixed(1)+";\n";
}
result = result + "    vCol = aCol;\n";
if (is_lit && !fixed_quads && !sprite_3d)
result = result + "    vNormal = normalize((normMatrix * vec4(aNorm, 1.)).xyz);\n";
if (has_texture || type === "text")
result = result + "    vTexcoord = aTexcoord;\n";
if (type == "text")
result = result + "    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);\n"+
"   pos = pos/pos.w;\n"+
"   gl_Position = pos + vec4(aOfs*textScale, 0.,0.);\n";
if (type == "sprites")
result = result + "    vec4 pos = mvMatrix * vec4(aPos, 1.);\n"+
"   pos = pos/pos.w + vec4(aOfs, 0., 0.);\n"+
"   gl_Position = prMatrix*pos;\n";
if (sprite_3d)
result = result + "    vNormal = normalize((normMatrix * vec4(aNorm, 1.)).xyz);\n"+
"   vec4 pos = mvMatrix * vec4(uOrig, 1.);\n"+
"   vPosition = pos/pos.w + vec4(uSize*(vec4(aPos, 1.)*usermat).xyz,0.);\n"+
"   gl_Position = prMatrix * vPosition;\n";
result = result + "  }\n";
return result;
};
this.getFragmentShader = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
sprites_3d = flags & this.f_sprites_3d,
nclipplanes = this.countClipplanes(), i,
texture_format, nlights,
result;
if (type === "clipplanes" || sprites_3d) return;
if (has_texture)
texture_format = this.getMaterial(id, "textype");
result = "/* ****** "+type+" object "+id+" fragment shader ****** */\n"+
"#ifdef GL_ES\n"+
"  precision highp float;\n"+
"#endif\n"+
"  varying vec4 vCol; // carries alpha\n"+
"  varying vec4 vPosition;\n";
if (has_texture || type === "text")
result = result + "  varying vec2 vTexcoord;\n"+
" uniform sampler2D uSampler;\n";
if (is_lit && !fixed_quads)
result = result + "  varying vec3 vNormal;\n";
for (i = 0; i < nclipplanes; i++)
result = result + "  uniform vec4 vClipplane"+i+";\n";
if (is_lit) {
nlights = this.countLights();
if (nlights)
result = result + "  uniform mat4 mvMatrix;\n";
else
is_lit = false;
}
if (is_lit) {
result = result + "    uniform vec3 emission;\n"+
"   uniform float shininess;\n";
for (i=0; i < nlights; i++) {
result = result + "    uniform vec3 ambient" + i + ";\n"+
"   uniform vec3 specular" + i +"; // light*material\n"+
"   uniform vec3 diffuse" + i + ";\n"+
"   uniform vec3 lightDir" + i + ";\n"+
"   uniform bool viewpoint" + i + ";\n"+
"   uniform bool finite" + i + ";\n";
}
}
result = result + "  void main(void) {\n";
for (i=0; i < nclipplanes;i++)
result = result + "    if (dot(vPosition, vClipplane"+i+") < 0.0) discard;\n";
if (is_lit) {
result = result + "    vec3 eye = normalize(-vPosition.xyz);\n"+
"   vec3 lightdir;\n"+
"   vec4 colDiff;\n"+
"   vec3 halfVec;\n"+
"   vec4 lighteffect = vec4(emission, 0.);\n"+
"   vec3 col;\n"+
"   float nDotL;\n";
if (fixed_quads) {
result = result +   "    vec3 n = vec3(0., 0., 1.);\n";
}
else {
result = result +   "    vec3 n = normalize(vNormal);\n"+
"   n = -faceforward(n, n, eye);\n";
}
for (i=0; i < nlights; i++) {
result = result + "   colDiff = vec4(vCol.rgb * diffuse" + i + ", vCol.a);\n"+
"   lightdir = lightDir" + i + ";\n"+
"   if (!viewpoint" + i +")\n"+
"     lightdir = (mvMatrix * vec4(lightdir, 1.)).xyz;\n"+
"   if (!finite" + i + ") {\n"+
"     halfVec = normalize(lightdir + eye);\n"+
"   } else {\n"+
"     lightdir = normalize(lightdir - vPosition.xyz);\n"+
"     halfVec = normalize(lightdir + eye);\n"+
"   }\n"+
"    col = ambient" + i + ";\n"+
"   nDotL = dot(n, lightdir);\n"+
"   col = col + max(nDotL, 0.) * colDiff.rgb;\n"+
"   col = col + pow(max(dot(halfVec, n), 0.), shininess) * specular" + i + ";\n"+
"   lighteffect = lighteffect + vec4(col, colDiff.a);\n";
}
} else {
result = result +   "   vec4 colDiff = vCol;\n"+
"    vec4 lighteffect = colDiff;\n";
}
if ((has_texture && texture_format === "rgba") || type === "text")
result = result +   "    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);\n";
if (has_texture) {
result = result + {
rgb:            "   vec4 textureColor = lighteffect*vec4(texture2D(uSampler, vTexcoord).rgb, 1.);\n",
alpha:          "   vec4 textureColor = texture2D(uSampler, vTexcoord);\n"+
"   float luminance = dot(vec3(1.,1.,1.), textureColor.rgb)/3.;\n"+
"   textureColor =  vec4(lighteffect.rgb, lighteffect.a*luminance);\n",
luminance:      "   vec4 textureColor = vec4(lighteffect.rgb*dot(texture2D(uSampler, vTexcoord).rgb, vec3(1.,1.,1.))/3., lighteffect.a);\n",
"luminance.alpha":"    vec4 textureColor = texture2D(uSampler, vTexcoord);\n"+
"   float luminance = dot(vec3(1.,1.,1.),textureColor.rgb)/3.;\n"+
"   textureColor = vec4(lighteffect.rgb*luminance, lighteffect.a*textureColor.a);\n"
}[texture_format]+
"   gl_FragColor = textureColor;\n";
} else if (type === "text") {
result = result +   "    if (textureColor.a < 0.1)\n"+
"     discard;\n"+
"   else\n"+
"     gl_FragColor = textureColor;\n";
} else
result = result +   "   gl_FragColor = lighteffect;\n";
result = result + "  }\n";
return result;
};
this.getShader = function(shaderType, code) {
var gl = this.gl, shader;
shader = gl.createShader(shaderType);
gl.shaderSource(shader, code);
gl.compileShader(shader);
if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS) && !gl.isContextLost())
alert(gl.getShaderInfoLog(shader));
return shader;
};
this.handleLoadedTexture = function(texture, textureCanvas) { 
var gl = this.gl || this.initGL();
gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
gl.bindTexture(gl.TEXTURE_2D, texture);
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textureCanvas);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
gl.generateMipmap(gl.TEXTURE_2D);
gl.bindTexture(gl.TEXTURE_2D, null);
};
this.loadImageToTexture = function(uri, texture) {
var canvas = this.textureCanvas,
ctx = canvas.getContext("2d"),
image = new Image(),
self = this;
image.onload = function() {
var w = image.width,
h = image.height,
canvasX = self.getPowerOfTwo(w),
canvasY = self.getPowerOfTwo(h),
gl = self.gl || self.initGL(),
maxTexSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
if (maxTexSize > 4096) maxTexSize = 4096;
while (canvasX > 1 && canvasY > 1 && (canvasX > maxTexSize || canvasY > maxTexSize)) {
canvasX /= 2;
canvasY /= 2;
}
canvas.width = canvasX;
canvas.height = canvasY;
ctx.imageSmoothingEnabled = true;
ctx.drawImage(image, 0, 0, canvasX, canvasY);
self.handleLoadedTexture(texture, canvas);
self.drawScene();
};
image.src = uri;
};
this.drawTextToCanvas = function(text, cex, family, font) {
var canvasX, canvasY,
textY,
scaling = 20,
textColour = "white",
backgroundColour = "rgba(0,0,0,0)",
canvas = this.textureCanvas,
ctx = canvas.getContext("2d"),
i, textHeights = [], widths = [], offset = 0, offsets = [],
fontStrings = [],
getFontString = function(i) {
textHeights[i] = scaling*cex[i];
var fontString = textHeights[i] + "px",
family0 = family[i],
font0 = font[i];
if (family0 === "sans")
family0 = "sans-serif";
else if (family0 === "mono")
family0 = "monospace";
fontString = fontString + " " + family0;
if (font0 === 2 || font0 === 4)
fontString = "bold " + fontString;
if (font0 === 3 || font0 === 4)
fontString = "italic " + fontString;
return fontString;
};
cex = this.repeatToLen(cex, text.length);
family = this.repeatToLen(family, text.length);
font = this.repeatToLen(font, text.length);
canvasX = 1;
for (i = 0; i < text.length; i++)  {
ctx.font = fontStrings[i] = getFontString(i);
widths[i] = ctx.measureText(text[i]).width;
offset = offsets[i] = offset + 2*textHeights[i];
canvasX = (widths[i] > canvasX) ? widths[i] : canvasX;
}
canvasX = this.getPowerOfTwo(canvasX);
canvasY = this.getPowerOfTwo(offset);
canvas.width = canvasX;
canvas.height = canvasY;
ctx.fillStyle = backgroundColour;
ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
ctx.textBaseline = "alphabetic";
for(i = 0; i < text.length; i++) {
textY = offsets[i];
ctx.font = fontStrings[i];
ctx.fillStyle = textColour;
ctx.textAlign = "left";
ctx.fillText(text[i], 0,  textY);
}
return {canvasX:canvasX, canvasY:canvasY,
widths:widths, textHeights:textHeights,
offsets:offsets};
};
this.setViewport = function(id) {
var gl = this.gl || this.initGL(),
vp = this.getObj(id).par3d.viewport,
x = vp.x*this.canvas.width,
y = vp.y*this.canvas.height,
width = vp.width*this.canvas.width,
height = vp.height*this.canvas.height;
this.vp = {x:x, y:y, width:width, height:height};
gl.viewport(x, y, width, height);
gl.scissor(x, y, width, height);
gl.enable(gl.SCISSOR_TEST);
};
this.setprMatrix = function(id) {
var subscene = this.getObj(id),
embedding = subscene.embeddings.projection;
if (embedding === "replace")
this.prMatrix.makeIdentity();
else
this.setprMatrix(subscene.parent);
if (embedding === "inherit")
return;
// This is based on the Frustum::enclose code from geom.cpp
var bbox = subscene.par3d.bbox,
scale = subscene.par3d.scale,
ranges = [(bbox[1]-bbox[0])*scale[0]/2,
(bbox[3]-bbox[2])*scale[1]/2,
(bbox[5]-bbox[4])*scale[2]/2],
radius = Math.sqrt(this.sumsq(ranges))*1.1; // A bit bigger to handle labels
if (radius <= 0) radius = 1;
var observer = subscene.par3d.observer,
distance = observer[2],
FOV = subscene.par3d.FOV, ortho = FOV === 0,
t = ortho ? 1 : Math.tan(FOV*Math.PI/360),
near = distance - radius,
far = distance + radius,
hlen = t*near,
aspect = this.vp.width/this.vp.height,
z = subscene.par3d.zoom;
if (ortho) {
if (aspect > 1)
this.prMatrix.ortho(-hlen*aspect*z, hlen*aspect*z,
-hlen*z, hlen*z, near, far);
else
this.prMatrix.ortho(-hlen*z, hlen*z,
-hlen*z/aspect, hlen*z/aspect,
near, far);
} else {
if (aspect > 1)
this.prMatrix.frustum(-hlen*aspect*z, hlen*aspect*z,
-hlen*z, hlen*z, near, far);
else
this.prMatrix.frustum(-hlen*z, hlen*z,
-hlen*z/aspect, hlen*z/aspect,
near, far);
}
};
this.setmvMatrix = function(id) {
var observer = this.getObj(id).par3d.observer;
this.mvMatrix.makeIdentity();
this.setmodelMatrix(id);
this.mvMatrix.translate(-observer[0], -observer[1], -observer[2]);
};
this.setmodelMatrix = function(id) {
var subscene = this.getObj(id),
embedding = subscene.embeddings.model;
if (embedding !== "inherit") {
var scale = subscene.par3d.scale,
bbox = subscene.par3d.bbox,
center = [(bbox[0]+bbox[1])/2,
(bbox[2]+bbox[3])/2,
(bbox[4]+bbox[5])/2];
this.mvMatrix.translate(-center[0], -center[1], -center[2]);
this.mvMatrix.scale(scale[0], scale[1], scale[2]);
this.mvMatrix.multRight( subscene.par3d.userMatrix );
}
if (embedding !== "replace")
this.setmodelMatrix(subscene.parent);
};
this.setnormMatrix = function(subsceneid) {
var self = this,
recurse = function(id) {
var sub = self.getObj(id),
embedding = sub.embeddings.model;
if (embedding !== "inherit") {
var scale = sub.par3d.scale;
self.normMatrix.scale(1/scale[0], 1/scale[1], 1/scale[2]);
self.normMatrix.multRight(sub.par3d.userMatrix);
}
if (embedding !== "replace")
recurse(sub.parent);
};
self.normMatrix.makeIdentity();
recurse(subsceneid);
};
this.setprmvMatrix = function() {
this.prmvMatrix = new CanvasMatrix4( this.mvMatrix );
this.prmvMatrix.multRight( this.prMatrix );
};
this.countClipplanes = function() {
return this.countObjs("clipplanes");
};
this.countLights = function() {
return this.countObjs("light");
};
this.countObjs = function(type) {
var self = this,
bound = 0;
Object.keys(this.scene.objects).forEach(
function(key) {
if (self.getObj(parseInt(key, 10)).type === type)
bound = bound + 1;
});
return bound;
};
this.initSubscene = function(id) {
var sub = this.getObj(id),
i, obj;
if (sub.type !== "subscene")
return;
sub.par3d.userMatrix = this.toCanvasMatrix4(sub.par3d.userMatrix);
sub.par3d.listeners = [].concat(sub.par3d.listeners);
sub.backgroundId = undefined;
sub.subscenes = [];
sub.clipplanes = [];
sub.transparent = [];
sub.opaque = [];
sub.lights = [];
for (i=0; i < sub.objects.length; i++) {
obj = this.getObj(sub.objects[i]);
if (typeof obj === "undefined") {
sub.objects.splice(i, 1);
i--;
} else if (obj.type === "background")
sub.backgroundId = obj.id;
else
sub[this.whichList(obj.id)].push(obj.id);
}
};
this.copyObj = function(id, reuse) {
var obj = this.getObj(id),
prev = document.getElementById(reuse);
if (prev !== null) {
prev = prev.rglinstance;
var
prevobj = prev.getObj(id),
fields = ["flags", "type",
"colors", "vertices", "centers",
"normals", "offsets",
"texts", "cex", "family", "font", "adj",
"material",
"radii",
"texcoords",
"userMatrix", "ids",
"dim",
"par3d", "userMatrix",
"viewpoint", "finite"],
i;
for (i = 0; i < fields.length; i++) {
if (typeof prevobj[fields[i]] !== "undefined")
obj[fields[i]] = prevobj[fields[i]];
}
} else
console.warn("copyObj failed");
};
this.planeUpdateTriangles = function(id, bbox) {
var perms = [[0,0,1], [1,2,2], [2,1,0]],
x, xrow, elem, A, d, nhits, i, j, k, u, v, w, intersect, which, v0, v2, vx, reverse,
face1 = [], face2 = [], normals = [],
obj = this.getObj(id),
nPlanes = obj.normals.length;
obj.bbox = bbox;
obj.vertices = [];
obj.initialized = false;
for (elem = 0; elem < nPlanes; elem++) {
//    Vertex Av = normal.getRecycled(elem);
x = [];
A = obj.normals[elem];
d = obj.offsets[elem][0];
nhits = 0;
for (i=0; i<3; i++)
for (j=0; j<2; j++)
for (k=0; k<2; k++) {
u = perms[0][i];
v = perms[1][i];
w = perms[2][i];
if (A[w] !== 0.0) {
intersect = -(d + A[u]*bbox[j+2*u] + A[v]*bbox[k+2*v])/A[w];
if (bbox[2*w] < intersect && intersect < bbox[1+2*w]) {
xrow = [];
xrow[u] = bbox[j+2*u];
xrow[v] = bbox[k+2*v];
xrow[w] = intersect;
x.push(xrow);
face1[nhits] = j + 2*u;
face2[nhits] = k + 2*v;
nhits++;
}
}
}
if (nhits > 3) {
/* Re-order the intersections so the triangles work */
for (i=0; i<nhits-2; i++) {
which = 0; /* initialize to suppress warning */
for (j=i+1; j<nhits; j++) {
if (face1[i] == face1[j] || face1[i] == face2[j] ||
face2[i] == face1[j] || face2[i] == face2[j] ) {
which = j;
break;
}
}
if (which > i+1) {
this.swap(x, i+1, which);
this.swap(face1, i+1, which);
this.swap(face2, i+1, which);
}
}
}
if (nhits >= 3) {
/* Put in order so that the normal points out the FRONT of the faces */
v0 = [x[0][0] - x[1][0] , x[0][1] - x[1][1], x[0][2] - x[1][2]];
v2 = [x[2][0] - x[1][0] , x[2][1] - x[1][1], x[2][2] - x[1][2]];
/* cross-product */
vx = this.xprod(v0, v2);
reverse = this.dotprod(vx, A) > 0;
for (i=0; i<nhits-2; i++) {
obj.vertices.push(x[0]);
normals.push(A);
for (j=1; j<3; j++) {
obj.vertices.push(x[i + (reverse ? 3-j : j)]);
normals.push(A);
}
}
}
}
obj.pnormals = normals;
};
this.initObj = function(id) {
var obj = this.getObj(id),
flags = obj.flags,
type = obj.type,
is_indexed = flags & this.f_is_indexed,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
depth_sort = flags & this.f_depth_sort,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
gl = this.gl || this.initGL(),
texinfo, drawtype, nclipplanes, f, frowsize, nrows,
i,j,v, mat, uri, matobj;
if (typeof id !== "number") {
this.alertOnce("initObj id is "+typeof id);
}
obj.initialized = true;
if (type === "bboxdeco" || type === "subscene")
return;
if (type === "light") {
obj.ambient = new Float32Array(obj.colors[0].slice(0,3));
obj.diffuse = new Float32Array(obj.colors[1].slice(0,3));
obj.specular = new Float32Array(obj.colors[2].slice(0,3));
obj.lightDir = new Float32Array(obj.vertices[0]);
return;
}
if (type === "clipplanes") {
obj.vClipplane = this.flatten(this.cbind(obj.normals, obj.offsets));
return;
}
if (type == "background" && typeof obj.ids !== "undefined") {
obj.quad = this.flatten([].concat(obj.ids));
return;
}
if (typeof obj.vertices === "undefined")
obj.vertices = [];
v = obj.vertices;
obj.vertexCount = v.length;
if (!obj.vertexCount) return;
if (!sprites_3d) {
if (gl.isContextLost()) return;
obj.prog = gl.createProgram();
gl.attachShader(obj.prog, this.getShader( gl.VERTEX_SHADER,
this.getVertexShader(id) ));
gl.attachShader(obj.prog, this.getShader( gl.FRAGMENT_SHADER,
this.getFragmentShader(id) ));
//  Force aPos to location 0, aCol to location 1
gl.bindAttribLocation(obj.prog, 0, "aPos");
gl.bindAttribLocation(obj.prog, 1, "aCol");
gl.linkProgram(obj.prog);
var linked = gl.getProgramParameter(obj.prog, gl.LINK_STATUS);
if (!linked) {
// An error occurred while linking
var lastError = gl.getProgramInfoLog(obj.prog);
console.warn("Error in program linking:" + lastError);
gl.deleteProgram(obj.prog);
return;
}
}
if (type === "text") {
texinfo = this.drawTextToCanvas(obj.texts,
this.flatten(obj.cex),
this.flatten(obj.family),
this.flatten(obj.family));
}
if (fixed_quads && !sprites_3d) {
obj.ofsLoc = gl.getAttribLocation(obj.prog, "aOfs");
}
if (sprite_3d) {
obj.origLoc = gl.getUniformLocation(obj.prog, "uOrig");
obj.sizeLoc = gl.getUniformLocation(obj.prog, "uSize");
obj.usermatLoc = gl.getUniformLocation(obj.prog, "usermat");
}
if (has_texture || type == "text") {
obj.texture = gl.createTexture();
obj.texLoc = gl.getAttribLocation(obj.prog, "aTexcoord");
obj.sampler = gl.getUniformLocation(obj.prog, "uSampler");
}
if (has_texture) {
mat = obj.material;
if (typeof mat.uri !== "undefined")
uri = mat.uri;
else if (typeof mat.uriElementId === "undefined") {
matobj = this.getObj(mat.uriId);
if (typeof matobj !== "undefined") {
uri = matobj.material.uri;
} else {
uri = "";
}
} else
uri = document.getElementById(mat.uriElementId).rglinstance.getObj(mat.uriId).material.uri;
this.loadImageToTexture(uri, obj.texture);
}
if (type === "text") {
this.handleLoadedTexture(obj.texture, this.textureCanvas);
}
var stride = 3, nc, cofs, nofs, radofs, oofs, tofs, vnew, v1;
nc = obj.colorCount = obj.colors.length;
if (nc > 1) {
cofs = stride;
stride = stride + 4;
v = this.cbind(v, obj.colors);
} else {
cofs = -1;
obj.onecolor = this.flatten(obj.colors);
}
if (typeof obj.normals !== "undefined") {
nofs = stride;
stride = stride + 3;
v = this.cbind(v, typeof obj.pnormals !== "undefined" ? obj.pnormals : obj.normals);
} else
nofs = -1;
if (typeof obj.radii !== "undefined") {
radofs = stride;
stride = stride + 1;
if (obj.radii.length === v.length) {
v = this.cbind(v, obj.radii);
} else if (obj.radii.length === 1) {
v = v.map(function(row, i, arr) { return row.concat(obj.radii[0]);});
}
} else
radofs = -1;
if (type == "sprites" && !sprites_3d) {
tofs = stride;
stride += 2;
oofs = stride;
stride += 2;
vnew = new Array(4*v.length);
var size = obj.radii, s = size[0]/2;
for (i=0; i < v.length; i++) {
if (size.length > 1)
s = size[i]/2;
vnew[4*i]  = v[i].concat([0,0,-s,-s]);
vnew[4*i+1]= v[i].concat([1,0, s,-s]);
vnew[4*i+2]= v[i].concat([1,1, s, s]);
vnew[4*i+3]= v[i].concat([0,1,-s, s]);
}
v = vnew;
obj.vertexCount = v.length;
} else if (type === "text") {
tofs = stride;
stride += 2;
oofs = stride;
stride += 2;
vnew = new Array(4*v.length);
for (i=0; i < v.length; i++) {
vnew[4*i]  = v[i].concat([0,-0.5]).concat(obj.adj[0]);
vnew[4*i+1]= v[i].concat([1,-0.5]).concat(obj.adj[0]);
vnew[4*i+2]= v[i].concat([1, 1.5]).concat(obj.adj[0]);
vnew[4*i+3]= v[i].concat([0, 1.5]).concat(obj.adj[0]);
for (j=0; j < 4; j++) {
v1 = vnew[4*i+j];
v1[tofs+2] = 2*(v1[tofs]-v1[tofs+2])*texinfo.widths[i];
v1[tofs+3] = 2*(v1[tofs+1]-v1[tofs+3])*texinfo.textHeights[i];
v1[tofs] *= texinfo.widths[i]/texinfo.canvasX;
v1[tofs+1] = 1.0-(texinfo.offsets[i] -
v1[tofs+1]*texinfo.textHeights[i])/texinfo.canvasY;
vnew[4*i+j] = v1;
}
}
v = vnew;
obj.vertexCount = v.length;
} else if (typeof obj.texcoords !== "undefined") {
tofs = stride;
stride += 2;
oofs = -1;
v = this.cbind(v, obj.texcoords);
} else {
tofs = -1;
oofs = -1;
}
if (stride !== v[0].length) {
this.alertOnce("problem in stride calculation");
}
obj.vOffsets = {vofs:0, cofs:cofs, nofs:nofs, radofs:radofs, oofs:oofs, tofs:tofs, stride:stride};
obj.values = new Float32Array(this.flatten(v));
if (sprites_3d) {
obj.userMatrix = new CanvasMatrix4(obj.userMatrix);
obj.objects = this.flatten([].concat(obj.ids));
is_lit = false;
}
if (is_lit && !fixed_quads) {
obj.normLoc = gl.getAttribLocation(obj.prog, "aNorm");
}
nclipplanes = this.countClipplanes();
if (nclipplanes && !sprites_3d) {
obj.clipLoc = [];
for (i=0; i < nclipplanes; i++)
obj.clipLoc[i] = gl.getUniformLocation(obj.prog,"vClipplane" + i);
}
if (is_lit) {
obj.emissionLoc = gl.getUniformLocation(obj.prog, "emission");
obj.emission = new Float32Array(this.stringToRgb(this.getMaterial(id, "emission")));
obj.shininessLoc = gl.getUniformLocation(obj.prog, "shininess");
obj.shininess = this.getMaterial(id, "shininess");
obj.nlights = this.countLights();
obj.ambientLoc = [];
obj.ambient = new Float32Array(this.stringToRgb(this.getMaterial(id, "ambient")));
obj.specularLoc = [];
obj.specular = new Float32Array(this.stringToRgb(this.getMaterial(id, "specular")));
obj.diffuseLoc = [];
obj.lightDirLoc = [];
obj.viewpointLoc = [];
obj.finiteLoc = [];
for (i=0; i < obj.nlights; i++) {
obj.ambientLoc[i] = gl.getUniformLocation(obj.prog, "ambient" + i);
obj.specularLoc[i] = gl.getUniformLocation(obj.prog, "specular" + i);
obj.diffuseLoc[i] = gl.getUniformLocation(obj.prog, "diffuse" + i);
obj.lightDirLoc[i] = gl.getUniformLocation(obj.prog, "lightDir" + i);
obj.viewpointLoc[i] = gl.getUniformLocation(obj.prog, "viewpoint" + i);
obj.finiteLoc[i] = gl.getUniformLocation(obj.prog, "finite" + i);
}
}
if (is_indexed) {
if ((type === "quads" || type === "text" ||
type === "sprites") && !sprites_3d) {
nrows = Math.floor(obj.vertexCount/4);
f = Array(6*nrows);
for (i=0; i < nrows; i++) {
f[6*i] = 4*i;
f[6*i+1] = 4*i + 1;
f[6*i+2] = 4*i + 2;
f[6*i+3] = 4*i;
f[6*i+4] = 4*i + 2;
f[6*i+5] = 4*i + 3;
}
frowsize = 6;
} else if (type === "triangles") {
nrows = Math.floor(obj.vertexCount/3);
f = Array(3*nrows);
for (i=0; i < f.length; i++) {
f[i] = i;
}
frowsize = 3;
} else if (type === "spheres") {
nrows = obj.vertexCount;
f = Array(nrows);
for (i=0; i < f.length; i++) {
f[i] = i;
}
frowsize = 1;
} else if (type === "surface") {
var dim = obj.dim[0],
nx = dim[0],
nz = dim[1];
f = [];
for (j=0; j<nx-1; j++) {
for (i=0; i<nz-1; i++) {
f.push(j + nx*i,
j + nx*(i+1),
j + 1 + nx*(i+1),
j + nx*i,
j + 1 + nx*(i+1),
j + 1 + nx*i);
}
}
frowsize = 6;
}
obj.f = new Uint16Array(f);
if (depth_sort) {
drawtype = "DYNAMIC_DRAW";
} else {
drawtype = "STATIC_DRAW";
}
}
if (type !== "spheres" && !sprites_3d) {
obj.buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW); //
}
if (is_indexed && type !== "spheres" && !sprites_3d) {
obj.ibuf = gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obj.ibuf);
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, obj.f, gl[drawtype]);
}
if (!sprites_3d) {
obj.mvMatLoc = gl.getUniformLocation(obj.prog, "mvMatrix");
obj.prMatLoc = gl.getUniformLocation(obj.prog, "prMatrix");
}
if (type === "text") {
obj.textScaleLoc = gl.getUniformLocation(obj.prog, "textScale");
}
if (is_lit && !sprites_3d) {
obj.normMatLoc = gl.getUniformLocation(obj.prog, "normMatrix");
}
};
this.setDepthTest = function(id) {
var gl = this.gl || this.initGL(),
tests = {never: gl.NEVER,
less:  gl.LESS,
equal: gl.EQUAL,
lequal:gl.LEQUAL,
greater: gl.GREATER,
notequal: gl.NOTEQUAL,
gequal: gl.GEQUAL,
always: gl.ALWAYS},
test = tests[this.getMaterial(id, "depth_test")];
gl.depthFunc(test);
};
this.mode4type = {points : "POINTS",
linestrip : "LINE_STRIP",
abclines : "LINES",
lines : "LINES",
sprites : "TRIANGLES",
planes : "TRIANGLES",
text : "TRIANGLES",
quads : "TRIANGLES",
surface : "TRIANGLES",
triangles : "TRIANGLES"};
this.drawObj = function(id, subsceneid) {
var obj = this.getObj(id),
subscene = this.getObj(subsceneid),
flags = obj.flags,
type = obj.type,
is_indexed = flags & this.f_is_indexed,
is_lit = flags & this.f_is_lit,
has_texture = flags & this.f_has_texture,
fixed_quads = flags & this.f_fixed_quads,
depth_sort = flags & this.f_depth_sort,
sprites_3d = flags & this.f_sprites_3d,
sprite_3d = flags & this.f_sprite_3d,
is_lines = flags & this.f_is_lines,
gl = this.gl || this.initGL(),
sphereMV, baseofs, ofs, sscale, i, count, light,
faces;
if (typeof id !== "number") {
this.alertOnce("drawObj id is "+typeof id);
}
if (type === "planes") {
if (obj.bbox !== subscene.par3d.bbox || !obj.initialized) {
this.planeUpdateTriangles(id, subscene.par3d.bbox);
}
}
if (!obj.initialized)
this.initObj(id);
if (type === "clipplanes") {
count = obj.offsets.length;
var IMVClip = [];
for (i=0; i < count; i++) {
IMVClip[i] = this.multMV(this.invMatrix, obj.vClipplane.slice(4*i, 4*(i+1)));
}
obj.IMVClip = IMVClip;
return;
}
if (type === "light" || type === "bboxdeco" || !obj.vertexCount)
return;
this.setDepthTest(id);
if (sprites_3d) {
var norigs = obj.vertices.length,
savenorm = new CanvasMatrix4(this.normMatrix);
this.origs = obj.vertices;
this.usermat = new Float32Array(obj.userMatrix.getAsArray());
this.radii = obj.radii;
this.normMatrix = subscene.spriteNormmat;
for (this.iOrig=0; this.iOrig < norigs; this.iOrig++) {
for (i=0; i < obj.objects.length; i++) {
this.drawObj(obj.objects[i], subsceneid);
}
}
this.normMatrix = savenorm;
return;
} else {
gl.useProgram(obj.prog);
}
if (sprite_3d) {
gl.uniform3fv(obj.origLoc, new Float32Array(this.origs[this.iOrig]));
if (this.radii.length > 1) {
gl.uniform1f(obj.sizeLoc, this.radii[this.iOrig][0]);
} else {
gl.uniform1f(obj.sizeLoc, this.radii[0][0]);
}
gl.uniformMatrix4fv(obj.usermatLoc, false, this.usermat);
}
if (type === "spheres") {
gl.bindBuffer(gl.ARRAY_BUFFER, this.sphere.buf);
} else {
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
}
if (is_indexed && type !== "spheres") {
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, obj.ibuf);
} else if (type === "spheres") {
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.sphere.ibuf);
}
gl.uniformMatrix4fv( obj.prMatLoc, false, new Float32Array(this.prMatrix.getAsArray()) );
gl.uniformMatrix4fv( obj.mvMatLoc, false, new Float32Array(this.mvMatrix.getAsArray()) );
var clipcheck = 0,
clipplaneids = subscene.clipplanes,
clip, j;
for (i=0; i < clipplaneids.length; i++) {
clip = this.getObj(clipplaneids[i]);
for (j=0; j < clip.offsets.length; j++) {
gl.uniform4fv(obj.clipLoc[clipcheck + j], clip.IMVClip[j]);
}
clipcheck += clip.offsets.length;
}
if (typeof obj.clipLoc !== "undefined")
for (i=clipcheck; i < obj.clipLoc.length; i++)
gl.uniform4f(obj.clipLoc[i], 0,0,0,0);
if (is_lit) {
gl.uniformMatrix4fv( obj.normMatLoc, false, new Float32Array(this.normMatrix.getAsArray()) );
gl.uniform3fv( obj.emissionLoc, obj.emission);
gl.uniform1f( obj.shininessLoc, obj.shininess);
for (i=0; i < subscene.lights.length; i++) {
light = this.getObj(subscene.lights[i]);
gl.uniform3fv( obj.ambientLoc[i], this.componentProduct(light.ambient, obj.ambient));
gl.uniform3fv( obj.specularLoc[i], this.componentProduct(light.specular, obj.specular));
gl.uniform3fv( obj.diffuseLoc[i], light.diffuse);
gl.uniform3fv( obj.lightDirLoc[i], light.lightDir);
gl.uniform1i( obj.viewpointLoc[i], light.viewpoint);
gl.uniform1i( obj.finiteLoc[i], light.finite);
}
for (i=subscene.lights.length; i < obj.nlights; i++) {
gl.uniform3f( obj.ambientLoc[i], 0,0,0);
gl.uniform3f( obj.specularLoc[i], 0,0,0);
gl.uniform3f( obj.diffuseLoc[i], 0,0,0);
}
}
if (type === "text") {
gl.uniform2f( obj.textScaleLoc, 0.75/this.vp.width, 0.75/this.vp.height);
}
gl.enableVertexAttribArray( this.posLoc );
var nc = obj.colorCount;
count = obj.vertexCount;
if (depth_sort) {
var nfaces = obj.centers.length,
frowsize, z, w;
if (sprites_3d) frowsize = 1;
else if (type === "triangles") frowsize = 3;
else frowsize = 6;
var depths = new Float32Array(nfaces);
faces = new Array(nfaces);
for(i=0; i<nfaces; i++) {
z = this.prmvMatrix.m13*obj.centers[3*i] +
this.prmvMatrix.m23*obj.centers[3*i+1] +
this.prmvMatrix.m33*obj.centers[3*i+2] +
this.prmvMatrix.m43;
w = this.prmvMatrix.m14*obj.centers[3*i] +
this.prmvMatrix.m24*obj.centers[3*i+1] +
this.prmvMatrix.m34*obj.centers[3*i+2] +
this.prmvMatrix.m44;
depths[i] = z/w;
faces[i] = i;
}
var depthsort = function(i,j) { return depths[j] - depths[i]; };
faces.sort(depthsort);
if (type !== "spheres") {
var f = new Uint16Array(obj.f.length);
for (i=0; i<nfaces; i++) {
for (j=0; j<frowsize; j++) {
f[frowsize*i + j] = obj.f[frowsize*faces[i] + j];
}
}
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, f, gl.DYNAMIC_DRAW);
}
}
if (type === "spheres") {
subscene = this.getObj(subsceneid);
var scale = subscene.par3d.scale,
scount = count;
gl.vertexAttribPointer(this.posLoc,  3, gl.FLOAT, false, 4*this.sphere.vOffsets.stride,  0);
gl.enableVertexAttribArray(obj.normLoc );
gl.vertexAttribPointer(obj.normLoc,  3, gl.FLOAT, false, 4*this.sphere.vOffsets.stride,  0);
gl.disableVertexAttribArray( this.colLoc );
var sphereNorm = new CanvasMatrix4();
sphereNorm.scale(scale[0], scale[1], scale[2]);
sphereNorm.multRight(this.normMatrix);
gl.uniformMatrix4fv( obj.normMatLoc, false, new Float32Array(sphereNorm.getAsArray()) );
if (nc == 1) {
gl.vertexAttrib4fv( this.colLoc, new Float32Array(obj.onecolor));
}
if (has_texture) {
gl.enableVertexAttribArray( obj.texLoc );
gl.vertexAttribPointer(obj.texLoc, 2, gl.FLOAT, false, 4*this.sphere.vOffsets.stride, 4*this.sphere.vOffsets.tofs);
gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D, obj.texture);
gl.uniform1i( obj.sampler, 0);
}
for (i = 0; i < scount; i++) {
sphereMV = new CanvasMatrix4();
if (depth_sort) {
baseofs = faces[i]*obj.vOffsets.stride;
} else {
baseofs = i*obj.vOffsets.stride;
}
ofs = baseofs + obj.vOffsets.radofs;
sscale = obj.values[ofs];
sphereMV.scale(sscale/scale[0], sscale/scale[1], sscale/scale[2]);
sphereMV.translate(obj.values[baseofs],
obj.values[baseofs+1],
obj.values[baseofs+2]);
sphereMV.multRight(this.mvMatrix);
gl.uniformMatrix4fv( obj.mvMatLoc, false, new Float32Array(sphereMV.getAsArray()) );
if (nc > 1) {
ofs = baseofs + obj.vOffsets.cofs;
gl.vertexAttrib4f( this.colLoc, obj.values[ofs],
obj.values[ofs+1],
obj.values[ofs+2],
obj.values[ofs+3] );
}
gl.drawElements(gl.TRIANGLES, this.sphere.sphereCount, gl.UNSIGNED_SHORT, 0);
}
return;
} else {
if (obj.colorCount === 1) {
gl.disableVertexAttribArray( this.colLoc );
gl.vertexAttrib4fv( this.colLoc, new Float32Array(obj.onecolor));
} else {
gl.enableVertexAttribArray( this.colLoc );
gl.vertexAttribPointer(this.colLoc, 4, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.cofs);
}
}
if (is_lit && obj.vOffsets.nofs > 0) {
gl.enableVertexAttribArray( obj.normLoc );
gl.vertexAttribPointer(obj.normLoc, 3, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.nofs);
}
if (has_texture || type === "text") {
gl.enableVertexAttribArray( obj.texLoc );
gl.vertexAttribPointer(obj.texLoc, 2, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.tofs);
gl.activeTexture(gl.TEXTURE0);
gl.bindTexture(gl.TEXTURE_2D, obj.texture);
gl.uniform1i( obj.sampler, 0);
}
if (fixed_quads) {
gl.enableVertexAttribArray( obj.ofsLoc );
gl.vertexAttribPointer(obj.ofsLoc, 2, gl.FLOAT, false, 4*obj.vOffsets.stride, 4*obj.vOffsets.oofs);
}
var mode = this.mode4type[type];
if (type === "sprites" || type === "text" || type === "quads") {
count = count * 6/4;
} else if (type === "surface") {
count = obj.f.length;
}
if (is_lines) {
gl.lineWidth( this.getMaterial(id, "lwd") );
}
gl.vertexAttribPointer(this.posLoc,  3, gl.FLOAT, false, 4*obj.vOffsets.stride,  4*obj.vOffsets.vofs);
if (is_indexed) {
gl.drawElements(gl[mode], count, gl.UNSIGNED_SHORT, 0);
} else {
gl.drawArrays(gl[mode], 0, count);
}
};
this.drawBackground = function(id, subsceneid) {
var gl = this.gl || this.initGL(),
obj = this.getObj(id),
bg, i;
if (!obj.initialized)
this.initObj(id);
if (obj.colors.length) {
bg = obj.colors[0];
gl.clearColor(bg[0], bg[1], bg[2], bg[3]);
gl.depthMask(true);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
}
if (typeof obj.quad !== "undefined") {
this.prMatrix.makeIdentity();
this.mvMatrix.makeIdentity();
gl.disable(gl.BLEND);
gl.disable(gl.DEPTH_TEST);
gl.depthMask(false);
for (i=0; i < obj.quad.length; i++)
this.drawObj(obj.quad[i], subsceneid);
}
};
this.drawSubscene = function(subsceneid) {
var gl = this.gl || this.initGL(),
obj = this.getObj(subsceneid),
objects = this.scene.objects,
subids = obj.objects,
subscene_has_faces = false,
subscene_needs_sorting = false,
flags, i;
if (obj.par3d.skipRedraw)
return;
for (i=0; i < subids.length; i++) {
flags = objects[subids[i]].flags;
if (typeof flags !== "undefined") {
subscene_has_faces |= (flags & this.f_is_lit)
& !(flags & this.f_fixed_quads);
subscene_needs_sorting |= (flags & this.f_depth_sort);
}
}
this.setViewport(subsceneid);
if (typeof obj.backgroundId !== "undefined")
this.drawBackground(obj.backgroundId, subsceneid);
if (subids.length) {
this.setprMatrix(subsceneid);
this.setmvMatrix(subsceneid);
if (subscene_has_faces) {
this.setnormMatrix(subsceneid);
if ((obj.flags & this.f_sprites_3d) &&
typeof obj.spriteNormmat === "undefined") {
obj.spriteNormmat = new CanvasMatrix4(this.normMatrix);
}
}
if (subscene_needs_sorting)
this.setprmvMatrix();
gl.enable(gl.DEPTH_TEST);
gl.depthMask(true);
gl.disable(gl.BLEND);
var clipids = obj.clipplanes;
if (typeof clipids === "undefined") {
console.warn("bad clipids");
}
if (clipids.length > 0) {
this.invMatrix = new CanvasMatrix4(this.mvMatrix);
this.invMatrix.invert();
for (i = 0; i < clipids.length; i++)
this.drawObj(clipids[i], subsceneid);
}
subids = obj.opaque;
if (subids.length > 0) {
for (i = 0; i < subids.length; i++) {
this.drawObj(subids[i], subsceneid);
}
}
subids = obj.transparent;
if (subids.length > 0) {
gl.depthMask(false);
gl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA,
gl.ONE, gl.ONE);
gl.enable(gl.BLEND);
for (i = 0; i < subids.length; i++) {
this.drawObj(subids[i], subsceneid);
}
}
subids = obj.subscenes;
for (i = 0; i < subids.length; i++) {
this.drawSubscene(subids[i]);
}
}
};
this.relMouseCoords = function(event) {
var totalOffsetX = 0,
totalOffsetY = 0,
currentElement = this.canvas;
do {
totalOffsetX += currentElement.offsetLeft;
totalOffsetY += currentElement.offsetTop;
currentElement = currentElement.offsetParent;
}
while(currentElement);
var canvasX = event.pageX - totalOffsetX,
canvasY = event.pageY - totalOffsetY;
return {x:canvasX, y:canvasY};
};
this.setMouseHandlers = function() {
var self = this, activeSubscene, handler,
handlers = {}, drag = 0;
handlers.rotBase = 0;
this.screenToVector = function(x, y) {
var viewport = this.getObj(activeSubscene).par3d.viewport,
width = viewport.width*this.canvas.width,
height = viewport.height*this.canvas.height,
radius = Math.max(width, height)/2.0,
cx = width/2.0,
cy = height/2.0,
px = (x-cx)/radius,
py = (y-cy)/radius,
plen = Math.sqrt(px*px+py*py);
if (plen > 1.e-6) {
px = px/plen;
py = py/plen;
}
var angle = (Math.SQRT2 - plen)/Math.SQRT2*Math.PI/2,
z = Math.sin(angle),
zlen = Math.sqrt(1.0 - z*z);
px = px * zlen;
py = py * zlen;
return [px, py, z];
};
handlers.trackballdown = function(x,y) {
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
handlers.rotBase = this.screenToVector(x, y);
this.saveMat = [];
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.saveMat = new CanvasMatrix4(activeSub.par3d.userMatrix);
}
};
handlers.trackballmove = function(x,y) {
var rotCurrent = this.screenToVector(x,y),
rotBase = handlers.rotBase,
dot = rotBase[0]*rotCurrent[0] +
rotBase[1]*rotCurrent[1] +
rotBase[2]*rotCurrent[2],
angle = Math.acos( dot/this.vlen(rotBase)/this.vlen(rotCurrent) )*180.0/Math.PI,
axis = this.xprod(rotBase, rotCurrent),
objects = this.scene.objects,
activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
l = activeModel.par3d.listeners,
i;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.userMatrix.load(objects[l[i]].saveMat);
activeSub.par3d.userMatrix.rotate(angle, axis[0], axis[1], axis[2]);
}
this.drawScene();
};
handlers.trackballend = 0;
handlers.axisdown = function(x,y) {
handlers.rotBase = this.screenToVector(x, this.canvas.height/2);
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.saveMat = new CanvasMatrix4(activeSub.par3d.userMatrix);
}
};
handlers.axismove = function(x,y) {
var rotCurrent = this.screenToVector(x, this.canvas.height/2),
rotBase = handlers.rotBase,
angle = (rotCurrent[0] - rotBase[0])*180/Math.PI,
rotMat = new CanvasMatrix4();
rotMat.rotate(angle, handlers.axis[0], handlers.axis[1], handlers.axis[2]);
var activeSub = this.getObj(activeSubscene),
activeModel = this.getObj(this.useid(activeSub.id, "model")),
i, l = activeModel.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.userMatrix.load(activeSub.saveMat);
activeSub.par3d.userMatrix.multLeft(rotMat);
}
this.drawScene();
};
handlers.axisend = 0;
handlers.y0zoom = 0;
handlers.zoom0 = 0;
handlers.zoomdown = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
handlers.y0zoom = y;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.zoom0 = Math.log(activeSub.par3d.zoom);
}
};
handlers.zoommove = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.zoom = Math.exp(activeSub.zoom0 + (y-handlers.y0zoom)/this.canvas.height);
}
this.drawScene();
};
handlers.zoomend = 0;
handlers.y0fov = 0;
handlers.fovdown = function(x, y) {
handlers.y0fov = y;
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.fov0 = activeSub.par3d.FOV;
}
};
handlers.fovmove = function(x, y) {
var activeSub = this.getObj(activeSubscene),
activeProjection = this.getObj(this.useid(activeSub.id, "projection")),
i, l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = this.getObj(l[i]);
activeSub.par3d.FOV = Math.max(1, Math.min(179, activeSub.fov0 +
180*(y-handlers.y0fov)/this.canvas.height));
}
this.drawScene();
};
handlers.fovend = 0;
this.canvas.onmousedown = function ( ev ){
if (!ev.which) // Use w3c defns in preference to MS
switch (ev.button) {
case 0: ev.which = 1; break;
case 1:
case 4: ev.which = 2; break;
case 2: ev.which = 3;
}
drag = ["left", "middle", "right"][ev.which-1];
var coords = self.relMouseCoords(ev);
coords.y = self.canvas.height-coords.y;
activeSubscene = self.whichSubscene(coords);
var sub = self.getObj(activeSubscene), f;
handler = sub.par3d.mouseMode[drag];
switch (handler) {
case "xAxis":
handler = "axis";
handlers.axis = [1.0, 0.0, 0.0];
break;
case "yAxis":
handler = "axis";
handlers.axis = [0.0, 1.0, 0.0];
break;
case "zAxis":
handler = "axis";
handlers.axis = [0.0, 0.0, 1.0];
break;
}
f = handlers[handler + "down"];
if (f) {
coords = self.translateCoords(activeSubscene, coords);
f.call(self, coords.x, coords.y);
ev.preventDefault();
}
};
this.canvas.onmouseup = function ( ev ){
if ( drag === 0 ) return;
var f = handlers[handler + "up"];
if (f)
f();
drag = 0;
};
this.canvas.onmouseout = this.canvas.onmouseup;
this.canvas.onmousemove = function ( ev ) {
if ( drag === 0 ) return;
var f = handlers[handler + "move"];
if (f) {
var coords = self.relMouseCoords(ev);
coords.y = self.canvas.height - coords.y;
coords = self.translateCoords(activeSubscene, coords);
f.call(self, coords.x, coords.y);
}
};
handlers.wheelHandler = function(ev) {
var del = 1.02, i;
if (ev.shiftKey) del = 1.002;
var ds = ((ev.detail || ev.wheelDelta) > 0) ? del : (1 / del);
if (typeof activeSubscene === "undefined")
activeSubscene = self.scene.rootSubscene;
var activeSub = self.getObj(activeSubscene),
activeProjection = self.getObj(self.useid(activeSub.id, "projection")),
l = activeProjection.par3d.listeners;
for (i = 0; i < l.length; i++) {
activeSub = self.getObj(l[i]);
activeSub.par3d.zoom *= ds;
}
self.drawScene();
ev.preventDefault();
};
this.canvas.addEventListener("DOMMouseScroll", handlers.wheelHandler, false);
this.canvas.addEventListener("mousewheel", handlers.wheelHandler, false);
};
this.useid = function(subsceneid, type) {
var sub = this.getObj(subsceneid);
if (sub.embeddings[type] === "inherit")
return(this.useid(sub.parent, type));
else
return subsceneid;
};
this.inViewport = function(coords, subsceneid) {
var viewport = this.getObj(subsceneid).par3d.viewport,
x0 = coords.x - viewport.x*this.canvas.width,
y0 = coords.y - viewport.y*this.canvas.height;
return 0 <= x0 && x0 <= viewport.width*this.canvas.width &&
0 <= y0 && y0 <= viewport.height*this.canvas.height;
};
this.whichSubscene = function(coords) {
var self = this,
recurse = function(subsceneid) {
var subscenes = self.getChildSubscenes(subsceneid), i, id;
for (i=0; i < subscenes.length; i++) {
id = recurse(subscenes[i]);
if (typeof(id) !== "undefined")
return(id);
}
if (self.inViewport(coords, subsceneid))
return(subsceneid);
else
return undefined;
},
rootid = this.scene.rootSubscene,
result = recurse(rootid);
if (typeof(result) === "undefined")
result = rootid;
return result;
};
this.translateCoords = function(subsceneid, coords) {
var viewport = this.getObj(subsceneid).par3d.viewport;
return {x: coords.x - viewport.x*this.canvas.width,
y: coords.y - viewport.y*this.canvas.height};
};
this.initSphere = function() {
var verts = this.scene.sphereVerts, 
reuse = verts.reuse, result;
if (typeof reuse !== "undefined") {
var prev = document.getElementById(reuse).rglinstance.sphere;
result = {values: prev.values, vOffsets: prev.vOffsets, it: prev.it};
} else 
result = {values: new Float32Array(this.flatten(this.cbind(this.transpose(verts.vb),
this.transpose(verts.texcoords)))),
it: new Uint16Array(this.flatten(this.transpose(verts.it))),
vOffsets: {vofs:0, cofs:-1, nofs:-1, radofs:-1, oofs:-1, 
tofs:3, stride:5}};
result.sphereCount = result.it.length;
this.sphere = result;
};
this.initSphereGL = function() {
var gl = this.gl || this.initGL(), sphere = this.sphere;
if (gl.isContextLost()) return;
sphere.buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, sphere.buf);
gl.bufferData(gl.ARRAY_BUFFER, sphere.values, gl.STATIC_DRAW);
sphere.ibuf = gl.createBuffer();
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, sphere.ibuf);
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, sphere.it, gl.STATIC_DRAW);
return;
};
this.initialize = function(el, x) {
this.textureCanvas = document.createElement("canvas");
this.textureCanvas.style.display = "block";
this.scene = x;
this.normMatrix = new CanvasMatrix4();
this.saveMat = {};
this.distance = null;
this.posLoc = 0;
this.colLoc = 1;
if (el) {
el.rglinstance = this;
this.el = el;
this.webGLoptions = el.rglinstance.scene.webGLoptions;
this.initCanvas();
}
};
this.restartCanvas = function() {
var newcanvas = document.createElement("canvas");
newcanvas.width = this.el.width;
newcanvas.height = this.el.height;
newcanvas.addEventListener("webglcontextrestored",
this.onContextRestored, false);
newcanvas.addEventListener("webglcontextlost",
this.onContextLost, false);            
while (this.el.firstChild) {
this.el.removeChild(this.el.firstChild);
}
this.el.appendChild(newcanvas);
this.canvas = newcanvas;
this.gl = null;         
}
this.initCanvas = function() {
this.restartCanvas();
var objs = this.scene.objects,
self = this;
Object.keys(objs).forEach(function(key){
var id = parseInt(key, 10),
obj = self.getObj(id);
if (typeof obj.reuse !== "undefined")
self.copyObj(id, obj.reuse);
});
Object.keys(objs).forEach(function(key){
self.initSubscene(parseInt(key, 10));
});
this.setMouseHandlers();      
this.initSphere();
this.onContextRestored = function(event) {
self.initGL();
self.drawScene();
console.log("restored context for "+self.scene.rootSubscene);
}
this.onContextLost = function(event) {
if (!self.drawing)
self.restartCanvas();
event.preventDefault();
}
this.initGL0();
lazyLoadScene = function() {
if (self.isInBrowserViewport()) {
if (!self.gl) {
self.initGL();
}
self.drawScene();
}
}
window.addEventListener("DOMContentLoaded", lazyLoadScene, false);
window.addEventListener("load", lazyLoadScene, false);
window.addEventListener("resize", lazyLoadScene, false);
window.addEventListener("scroll", lazyLoadScene, false);
};
/* this is only used by writeWebGL; rglwidget has
no debug element and does the drawing in rglwidget.js */
this.start = function() {
if (typeof this.prefix !== "undefined") {
this.debugelement = document.getElementById(this.prefix + "debug");
this.debug("");
}
this.drag = 0;
this.drawScene();
};
this.debug = function(msg, img) {
if (typeof this.debugelement !== "undefined" && this.debugelement !== null) {
this.debugelement.innerHTML = msg;
if (typeof img !== "undefined") {
this.debugelement.insertBefore(img, this.debugelement.firstChild);
}
} else if (msg !== "")
alert(msg);
};
this.getSnapshot = function() {
var img;
if (typeof this.scene.snapshot !== "undefined") {
img = document.createElement("img");
img.src = this.scene.snapshot;
img.alt = "Snapshot";
}
return img;
};
this.initGL0 = function() {
if (!window.WebGLRenderingContext){
alert("Your browser does not support WebGL. See http://get.webgl.org");
return;
}
};
this.isInBrowserViewport = function() {
var rect = this.canvas.getBoundingClientRect(),
windHeight = (window.innerHeight || document.documentElement.clientHeight),
windWidth = (window.innerWidth || document.documentElement.clientWidth);
return (
rect.top >= -windHeight &&
rect.left >= -windWidth &&
rect.bottom <= 2*windHeight &&
rect.right <= 2*windWidth);
}
this.initGL = function() {
var self = this;
if (this.gl) {
if (!this.drawing && this.gl.isContextLost())
this.restartCanvas();
else
return this.gl;
}
// if (!this.isInBrowserViewport()) return; Return what??? At this point we know this.gl is null.
this.canvas.addEventListener("webglcontextrestored",
this.onContextRestored, false);
this.canvas.addEventListener("webglcontextlost",
this.onContextLost, false);      
this.gl = this.canvas.getContext("webgl", this.webGLoptions) ||
this.canvas.getContext("experimental-webgl", this.webGLoptions);
var save = this.startDrawing();
this.initSphereGL(); 
Object.keys(this.scene.objects).forEach(function(key){
self.initObj(parseInt(key, 10));
});
this.stopDrawing(save);
return this.gl;
};
this.resize = function(el) {
this.canvas.width = el.width;
this.canvas.height = el.height;
};
this.drawScene = function() {
var gl = this.gl || this.initGL(),
save = this.startDrawing();
gl.enable(gl.DEPTH_TEST);
gl.depthFunc(gl.LEQUAL);
gl.clearDepth(1.0);
gl.clearColor(1,1,1,1);
gl.depthMask(true); // Must be true before clearing depth buffer
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
this.drawSubscene(this.scene.rootSubscene);
this.stopDrawing(save);
};
this.subsetSetter = function(el, control) {
if (typeof control.subscenes === "undefined" ||
control.subscenes === null)
control.subscenes = this.scene.rootSubscene;
var value = Math.round(control.value),
subscenes = [].concat(control.subscenes),
i, j, entries, subsceneid,
ismissing = function(x) {
return control.fullset.indexOf(x) < 0;
},
tointeger = function(x) {
return parseInt(x, 10);
};
for (i=0; i < subscenes.length; i++) {
subsceneid = subscenes[i];
if (typeof this.getObj(subsceneid) === "undefined")
this.alertOnce("typeof object is undefined");
entries = this.getObj(subsceneid).objects;
entries = entries.filter(ismissing);
if (control.accumulate) {
for (j=0; j<=value; j++)
entries = entries.concat(control.subsets[j]);
} else {
entries = entries.concat(control.subsets[value]);
}
entries = entries.map(tointeger);
this.setSubsceneEntries(this.unique(entries), subsceneid);
}
};
this.propertySetter = function(el, control)  {
var value = control.value,
values = [].concat(control.values),
svals = [].concat(control.param),
direct = values[0] === null,
entries = [].concat(control.entries),
ncol = entries.length,
nrow = values.length/ncol,
properties = this.repeatToLen(control.properties, ncol),
objids = this.repeatToLen(control.objids, ncol),
property = properties[0], objid = objids[0],
obj = this.getObj(objid),
propvals, i, v1, v2, p, entry, gl, needsBinding,
newprop, newid,
getPropvals = function() {
if (property === "userMatrix")
return obj.userMatrix.getAsArray();
else
return obj[property];
};
if (direct && typeof value === "undefined")
return;
if (control.interp) {
values = values.slice(0, ncol).concat(values).
concat(values.slice(ncol*(nrow-1), ncol*nrow));
svals = [-Infinity].concat(svals).concat(Infinity);
for (i = 1; i < svals.length; i++) {
if (value <= svals[i]) {
if (svals[i] === Infinity)
p = 1;
else
p = (svals[i] - value)/(svals[i] - svals[i-1]);
break;
}
}
} else if (!direct) {
value = Math.round(value);
}
propvals = getPropvals();
for (j=0; j<entries.length; j++) {
entry = entries[j];
newprop = properties[j];
newid = objids[j];
if (newprop != property || newid != objid) {
property = newprop;
objid = newid;
obj = this.getObj(objid);
propvals = getPropvals();
}
if (control.interp) {
v1 = values[ncol*(i-1) + j];
v2 = values[ncol*i + j];
this.setElement(propvals, entry, p*v1 + (1-p)*v2);
} else if (!direct) {
this.setElement(propvals, entry, values[ncol*value + j]);
} else {
this.setElement(propvals, entry, value[j]);
}
}
needsBinding = [];
for (j=0; j < entries.length; j++) {
if (properties[j] === "values" &&
needsBinding.indexOf(objids[j]) === -1) {
needsBinding.push(objids[j]);
}
}
for (j=0; j < needsBinding.length; j++) {
gl = this.gl || this.initGL();
obj = this.getObj(needsBinding[j]);
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW);
}
};
this.vertexSetter = function(el, control)  {
var svals = [].concat(control.param),
j, k, p, propvals, stride, ofs, obj,
attrib,
ofss    = {x:"vofs", y:"vofs", z:"vofs",
red:"cofs", green:"cofs", blue:"cofs",
alpha:"cofs", radii:"radofs",
nx:"nofs", ny:"nofs", nz:"nofs",
ox:"oofs", oy:"oofs", oz:"oofs",
ts:"tofs", tt:"tofs"},
pos     = {x:0, y:1, z:2,
red:0, green:1, blue:2,
alpha:3,radii:0,
nx:0, ny:1, nz:2,
ox:0, oy:1, oz:2,
ts:0, tt:1},
values = control.values,
direct = values === null,
ncol,
interp = control.interp,
vertices = [].concat(control.vertices),
attributes = [].concat(control.attributes),
value = control.value;
ncol = Math.max(vertices.length, attributes.length);
if (!ncol)
return;
vertices = this.repeatToLen(vertices, ncol);
attributes = this.repeatToLen(attributes, ncol);
if (direct)
interp = false;
/* JSON doesn't pass Infinity */
svals[0] = -Infinity;
svals[svals.length - 1] = Infinity;
for (j = 1; j < svals.length; j++) {
if (value <= svals[j]) {
if (interp) {
if (svals[j] === Infinity)
p = 1;
else
p = (svals[j] - value)/(svals[j] - svals[j-1]);
} else {
if (svals[j] - value > value - svals[j-1])
j = j - 1;
}
break;
}
}
obj = this.getObj(control.objid);
propvals = obj.values;
for (k=0; k<ncol; k++) {
attrib = attributes[k];
vertex = vertices[k];
ofs = obj.vOffsets[ofss[attrib]];
if (ofs < 0)
this.alertOnce("Attribute '"+attrib+"' not found in object "+control.objid);
else {
stride = obj.vOffsets.stride;
ofs = vertex*stride + ofs + pos[attrib];
if (direct) {
propvals[ofs] = value;
} else if (interp) {
propvals[ofs] = p*values[j-1][k] + (1-p)*values[j][k];
} else {
propvals[ofs] = values[j][k];
}
}
}
if (typeof obj.buf !== "undefined") {
var gl = this.gl || this.initGL();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, propvals, gl.STATIC_DRAW);
}
};
this.ageSetter = function(el, control) {
var objids = [].concat(control.objids),
nobjs = objids.length,
time = control.value,
births = [].concat(control.births),
ages = [].concat(control.ages),
steps = births.length,
j = Array(steps),
p = Array(steps),
i, k, age, j0, propvals, stride, ofs, objid, obj,
attrib, dim,
attribs = ["colors", "alpha", "radii", "vertices",
"normals", "origins", "texcoords",
"x", "y", "z",
"red", "green", "blue"],
ofss    = ["cofs", "cofs", "radofs", "vofs",
"nofs", "oofs", "tofs",
"vofs", "vofs", "vofs",
"cofs", "cofs", "cofs"],
dims    = [3,1,1,3,
3,2,2,
1,1,1,
1,1,1],
pos     = [0,3,0,0,
0,0,0,
0,1,2,
0,1,2];
/* Infinity doesn't make it through JSON */
ages[0] = -Infinity;
ages[ages.length-1] = Infinity;
for (i = 0; i < steps; i++) {
if (births[i] !== null) {  // NA in R becomes null
age = time - births[i];
for (j0 = 1; age > ages[j0]; j0++);
if (ages[j0] == Infinity)
p[i] = 1;
else if (ages[j0] > ages[j0-1])
p[i] = (ages[j0] - age)/(ages[j0] - ages[j0-1]);
else
p[i] = 0;
j[i] = j0;
}
}
for (l = 0; l < nobjs; l++) {
objid = objids[l];
obj = this.getObj(objid);
propvals = obj.values;
stride = obj.vOffsets.stride;
for (k = 0; k < attribs.length; k++) {
attrib = control[attribs[k]];
if (typeof attrib !== "undefined") {
ofs = obj.vOffsets[ofss[k]];
if (ofs >= 0) {
dim = dims[k];
ofs = ofs + pos[k];
for (i = 0; i < steps; i++) {
if (births[i] !== null) {
for (d=0; d < dim; d++) {
propvals[i*stride + ofs + d] = p[i]*attrib[dim*(j[i]-1) + d] + (1-p[i])*attrib[dim*j[i] + d];
}
}
}
} else
this.alertOnce("\'"+attribs[k]+"\' property not found in object "+objid);
}
}
obj.values = propvals;
if (typeof obj.buf !== "undefined") {
gl = this.gl || this.initGL();
gl.bindBuffer(gl.ARRAY_BUFFER, obj.buf);
gl.bufferData(gl.ARRAY_BUFFER, obj.values, gl.STATIC_DRAW);
}
}
};
this.oldBridge = function(el, control) {
var attrname, global = window[control.prefix + "rgl"];
if (typeof global !== "undefined")
for (attrname in global)
this[attrname] = global[attrname];
window[control.prefix + "rgl"] = this;
};
this.Player = function(el, control) {
var
self = this,
components = [].concat(control.components),
Tick = function() { /* "this" will be a timer */
var i,
nominal = this.value,
slider = this.Slider,
labels = this.outputLabels,
output = this.Output,
step;
if (typeof slider !== "undefined" && nominal != slider.value)
slider.value = nominal;
if (typeof output !== "undefined") {
step = Math.round((nominal - output.sliderMin)/output.sliderStep);
if (labels !== null) {
output.innerHTML = labels[step];
} else {
step = step*output.sliderStep + output.sliderMin;
output.innerHTML = step.toPrecision(output.outputPrecision);
}
}
for (i=0; i < this.actions.length; i++) {
this.actions[i].value = nominal;
}
self.applyControls(el, this.actions, false);
self.drawScene();
},
OnSliderInput = function() { /* "this" will be the slider */
this.rgltimer.value = Number(this.value);
this.rgltimer.Tick();
},
addSlider = function(min, max, step, value) {
var slider = document.createElement("input");
slider.type = "range";
slider.min = min;
slider.max = max;
slider.step = step;
slider.value = value;
slider.oninput = OnSliderInput;
slider.sliderActions = control.actions;
slider.sliderScene = this;
slider.className = "rgl-slider";
slider.id = el.id + "-slider";
el.rgltimer.Slider = slider;
slider.rgltimer = el.rgltimer;
el.appendChild(slider);
},
addLabel = function(labels, min, step, precision) {
var output = document.createElement("output");
output.sliderMin = min;
output.sliderStep = step;
output.outputPrecision = precision;
output.className = "rgl-label";
output.id = el.id + "-label";
el.rgltimer.Output = output;
el.rgltimer.outputLabels = labels;
el.appendChild(output);
},
addButton = function(label) {
var button = document.createElement("input"),
onclicks = {Reverse: function() { this.rgltimer.reverse();},
Play: function() { this.rgltimer.play();
this.value = this.rgltimer.enabled ? "Pause" : "Play"; },
Slower: function() { this.rgltimer.slower(); },
Faster: function() { this.rgltimer.faster(); },
Reset: function() { this.rgltimer.reset(); }};
button.rgltimer = el.rgltimer;
button.type = "button";
button.value = label;
if (label === "Play")
button.rgltimer.PlayButton = button;
button.onclick = onclicks[label];
button.className = "rgl-button";
button.id = el.id + "-" + label;
el.appendChild(button);
};
if (typeof control.reinit !== "undefined" && control.reinit !== null) {
control.actions.reinit = control.reinit;
}
el.rgltimer = new rgltimerClass(Tick, control.start, control.interval, control.stop, control.value, control.rate, control.loop, control.actions);
for (var i=0; i < components.length; i++) {
switch(components[i]) {
case "Slider": addSlider(control.start, control.stop,
control.step, control.value);
break;
case "Label": addLabel(control.labels, control.start,
control.step, control.precision);
break;
default:
addButton(components[i]);
}
}
el.rgltimer.Tick();
};
this.applyControls = function(el, x, draw) {
var self = this, reinit = x.reinit, i, control, type;
for (i = 0; i < x.length; i++) {
control = x[i];
type = control.type;
self[type](el, control);
}
if (typeof reinit !== "undefined" && reinit !== null) {
reinit = [].concat(reinit);
for (i = 0; i < reinit.length; i++)
self.getObj(reinit[i]).initialized = false;
}
if (typeof draw === "undefined" || draw)
self.drawScene();
};
this.sceneChangeHandler = function(message) {
var self = document.getElementById(message.elementId).rglinstance,
objs = message.objects, mat = message.material,
root = message.rootSubscene,
initSubs = message.initSubscenes,
redraw = message.redrawScene,
skipRedraw = message.skipRedraw,
deletes, subs, allsubs = [], i,j;
if (typeof message.delete !== "undefined") {
deletes = [].concat(message.delete);
if (typeof message.delfromSubscenes !== "undefined")
subs = [].concat(message.delfromSubscenes);
else
subs = [];
for (i = 0; i < deletes.length; i++) {
for (j = 0; j < subs.length; j++) {
self.delFromSubscene(deletes[i], subs[j]);
}
delete self.scene.objects[deletes[i]];
}
}
if (typeof objs !== "undefined") {
Object.keys(objs).forEach(function(key){
key = parseInt(key, 10);
self.scene.objects[key] = objs[key];
self.initObj(key);
var obj = self.getObj(key),
subs = [].concat(obj.inSubscenes), k;
allsubs = allsubs.concat(subs);
for (k = 0; k < subs.length; k++)
self.addToSubscene(key, subs[k]);
});
}
if (typeof mat !== "undefined") {
self.scene.material = mat;
}
if (typeof root !== "undefined") {
self.scene.rootSubscene = root;
}
if (typeof initSubs !== "undefined")
allsubs = allsubs.concat(initSubs);
allsubs = self.unique(allsubs);
for (i = 0; i < allsubs.length; i++) {
self.initSubscene(allsubs[i]);
}
if (typeof skipRedraw !== "undefined") {
root = self.getObj(self.scene.rootSubscene);
root.par3d.skipRedraw = skipRedraw;
}
if (redraw)
self.drawScene();
};
}).call(rglwidgetClass.prototype);
rgltimerClass = function(Tick, startTime, interval, stopTime, value, rate, loop, actions) {
this.enabled = false;
this.timerId = 0;
this.startTime = startTime;         /* nominal start time in seconds */
this.value = value;                 /* current nominal time */
this.interval = interval;           /* seconds between updates */
this.stopTime = stopTime;           /* nominal stop time */
this.rate = rate;                   /* nominal units per second */
this.loop = loop;                   /* "none", "cycle", or "oscillate" */
this.realStart = undefined;         /* real world start time */
this.multiplier = 1;                /* multiplier for fast-forward
or reverse */
this.actions = actions;
this.Tick = Tick;
};
(function() {
this.play = function() {
if (this.enabled) {
this.enabled = false;
window.clearInterval(this.timerId);
this.timerId = 0;
return;
}
var tick = function(self) {
var now = new Date();
self.value = self.multiplier*self.rate*(now - self.realStart)/1000 + self.startTime;
if (self.value > self.stopTime || self.value < self.startTime) {
if (!self.loop) {
self.reset();
} else {
var cycle = self.stopTime - self.startTime,
newval = (self.value - self.startTime) % cycle + self.startTime;
if (newval < self.startTime) {
newval += cycle;
}
self.realStart += (self.value - newval)*1000/self.multiplier/self.rate;
self.value = newval;
}
}
if (typeof self.Tick !== "undefined") {
self.Tick(self.value);
}
};
this.realStart = new Date() - 1000*(this.value - this.startTime)/this.rate/this.multiplier;
this.timerId = window.setInterval(tick, 1000*this.interval, this);
this.enabled = true;
};
this.reset = function() {
this.value = this.startTime;
this.newmultiplier(1);
if (typeof this.Tick !== "undefined") {
this.Tick(this.value);
}
if (this.enabled)
this.play();  /* really pause... */
if (typeof this.PlayButton !== "undefined")
this.PlayButton.value = "Play";
};
this.faster = function() {
this.newmultiplier(Math.SQRT2*this.multiplier);
};
this.slower = function() {
this.newmultiplier(this.multiplier/Math.SQRT2);
};
this.reverse = function() {
this.newmultiplier(-this.multiplier);
};
this.newmultiplier = function(newmult) {
if (newmult != this.multiplier) {
this.realStart += 1000*(this.value - this.startTime)/this.rate*(1/this.multiplier - 1/newmult);
this.multiplier = newmult;
}
};
}).call(rgltimerClass.prototype);</script>
<div id="biplot3div" class="rglWebGL">

</div>
<script type="text/javascript">
var biplot3div = document.getElementById("biplot3div"),
biplot3rgl = new rglwidgetClass();
biplot3div.width = 385;
biplot3div.height = 385;
biplot3rgl.initialize(biplot3div,
{"material":{"color":"#FFFFFF","alpha":1,"lit":true,"ambient":"#000000","specular":"#FFFFFF","emission":"#000000","shininess":50,"smooth":true,"front":"filled","back":"lines","size":3,"lwd":1,"fog":true,"point_antialias":false,"line_antialias":false,"texture":null,"textype":"rgb","texmipmap":false,"texminfilter":"linear","texmagfilter":"linear","texenvmap":false,"depth_mask":true,"depth_test":"less"},"rootSubscene":1,"objects":{"10":{"id":10,"type":"spheres","material":{},"vertices":[[-3.01998,0.2990217,0.1367679],[-1.931967,-5.46472,-1.092596],[0.06196691,0.1435347,1.022866],[-1.520572,-2.968761,1.49862],[0.8220779,-0.7590234,1.261936],[4.07337,2.086559,-0.9577541],[0.3288696,-0.3517465,3.427192],[2.003463,-1.408959,-3.443698],[2.671087,-0.7958061,0.6117787],[-1.76356,-0.6200543,-2.036622],[7.815898,0.4884962,0.2927126],[-2.386414,1.871343,1.129171],[-3.272479,2.258145,-0.6681634],[-1.851986,3.11873,-1.414499],[-2.029774,2.103241,0.2322887]],"colors":[[0,0,0,1]],"radii":[[0.156318]],"centers":[[-3.01998,0.2990217,0.1367679],[-1.931967,-5.46472,-1.092596],[0.06196691,0.1435347,1.022866],[-1.520572,-2.968761,1.49862],[0.8220779,-0.7590234,1.261936],[4.07337,2.086559,-0.9577541],[0.3288696,-0.3517465,3.427192],[2.003463,-1.408959,-3.443698],[2.671087,-0.7958061,0.6117787],[-1.76356,-0.6200543,-2.036622],[7.815898,0.4884962,0.2927126],[-2.386414,1.871343,1.129171],[-3.272479,2.258145,-0.6681634],[-1.851986,3.11873,-1.414499],[-2.029774,2.103241,0.2322887]],"ignoreExtent":false,"flags":3},"11":{"id":11,"type":"text","material":{"lit":false},"vertices":[[-3.09814,0.2208627,0.05860887],[-2.010126,-5.542879,-1.170755],[-0.01619207,0.06537569,0.9447067],[-1.598731,-3.04692,1.420461],[0.7439189,-0.8371824,1.183777],[3.995212,2.008399,-1.035913],[0.2507106,-0.4299055,3.349033],[1.925303,-1.487118,-3.521857],[2.592928,-0.873965,0.5336197],[-1.841719,-0.6982133,-2.114781],[7.737739,0.4103372,0.2145536],[-2.464573,1.793184,1.051012],[-3.350638,2.179986,-0.7463224],[-1.930145,3.040571,-1.492658],[-2.107933,2.025082,0.1541298]],"colors":[[0,0,0,1]],"texts":[["self"],["ideal self"],["mother"],["father"],["kurt"],["karl"],["george"],["martin"],["elizabeth"],["therapist"],["irene"],["childhood self"],["self before illness"],["self with delusion"],["self as dreamer"]],"cex":[[0.6]],"adj":[[1,1]],"centers":[[-3.09814,0.2208627,0.05860887],[-2.010126,-5.542879,-1.170755],[-0.01619207,0.06537569,0.9447067],[-1.598731,-3.04692,1.420461],[0.7439189,-0.8371824,1.183777],[3.995212,2.008399,-1.035913],[0.2507106,-0.4299055,3.349033],[1.925303,-1.487118,-3.521857],[2.592928,-0.873965,0.5336197],[-1.841719,-0.6982133,-2.114781],[7.737739,0.4103372,0.2145536],[-2.464573,1.793184,1.051012],[-3.350638,2.179986,-0.7463224],[-1.930145,3.040571,-1.492658],[-2.107933,2.025082,0.1541298]],"family":[["sans"]],"font":[[1]],"ignoreExtent":false,"flags":40},"12":{"id":12,"type":"lines","material":{"lit":false},"vertices":[[0.386304,-0.06258269,-0.3346449],[7.622866,-1.234933,-6.603486],[0.1037138,-0.4167697,0.1894142],[2.245022,-9.021533,4.100121],[-0.04420828,0.2150645,-0.1012773],[-1.857723,9.037451,-4.255881],[0.02152008,0.4199164,-0.176454],[0.4795222,9.356807,-3.931844],[0.33711,0.2325553,0.2125145],[7.423672,5.12122,4.67989],[0.2257524,-0.2631578,-0.101119],[6.351075,-7.403396,-2.844774],[-0.0309904,0.219315,0.07919913],[-1.338632,9.473326,3.421011],[0.08821715,-0.1499639,-0.1224664],[4.212817,-7.161538,-5.848394],[0.2950906,0.3088075,0.3365267],[5.513898,5.770205,6.28815],[-0.4003765,-0.01001787,0.3740094],[-7.423765,-0.185751,6.934867],[-0.03401585,0.3229545,0.1116129],[-1.006516,9.5561,3.302583],[0.3268435,0.187082,0.4772242],[5.462786,3.126845,7.976213],[0.1605406,-0.4132351,0.4524682],[2.575088,-6.628334,7.257636],[0.5320792,-0.01888357,-0.1897967],[9.564703,-0.3394527,-3.411803],[-0.386304,0.06258269,0.3346449],[-7.622866,1.234933,6.603486],[-0.1037138,0.4167697,-0.1894142],[-2.245022,9.021533,-4.100121],[0.04420828,-0.2150645,0.1012773],[1.857723,-9.037451,4.255881],[-0.02152008,-0.4199164,0.176454],[-0.4795222,-9.356807,3.931844],[-0.33711,-0.2325553,-0.2125145],[-7.423672,-5.12122,-4.67989],[-0.2257524,0.2631578,0.101119],[-6.351075,7.403396,2.844774],[0.0309904,-0.219315,-0.07919913],[1.338632,-9.473326,-3.421011],[-0.08821715,0.1499639,0.1224664],[-4.212817,7.161538,5.848394],[-0.2950906,-0.3088075,-0.3365267],[-5.513898,-5.770205,-6.28815],[0.4003765,0.01001787,-0.3740094],[7.423765,0.185751,-6.934867],[0.03401585,-0.3229545,-0.1116129],[1.006516,-9.5561,-3.302583],[-0.3268435,-0.187082,-0.4772242],[-5.462786,-3.126845,-7.976213],[-0.1605406,0.4132351,-0.4524682],[-2.575088,6.628334,-7.257636],[-0.5320792,0.01888357,0.1897967],[-9.564703,0.3394527,3.411803]],"colors":[[0.7450981,0.7450981,0.7450981,1]],"centers":[[4.004585,-0.6487576,-3.469065],[1.174368,-4.719151,2.144768],[-0.9509656,4.626257,-2.178579],[0.2505212,4.888361,-2.054149],[3.880391,2.676888,2.446202],[3.288414,-3.833277,-1.472946],[-0.6848114,4.84632,1.750105],[2.150517,-3.655751,-2.98543],[2.904494,3.039506,3.312339],[-3.912071,-0.09788442,3.654438],[-0.5202658,4.939527,1.707098],[2.894815,1.656963,4.226719],[1.367814,-3.520784,3.855052],[5.048391,-0.1791681,-1.8008],[-4.004585,0.6487576,3.469065],[-1.174368,4.719151,-2.144768],[0.9509656,-4.626257,2.178579],[-0.2505212,-4.888361,2.054149],[-3.880391,-2.676888,-2.446202],[-3.288414,3.833277,1.472946],[0.6848114,-4.84632,-1.750105],[-2.150517,3.655751,2.98543],[-2.904494,-3.039506,-3.312339],[3.912071,0.09788442,-3.654438],[0.5202658,-4.939527,-1.707098],[-2.894815,-1.656963,-4.226719],[-1.367814,3.520784,-3.855052],[-5.048391,0.1791681,1.8008]],"ignoreExtent":false,"flags":128},"13":{"id":13,"type":"text","material":{"lit":false},"vertices":[[7.622866,-1.234933,-6.603486],[2.245022,-9.021533,4.100121],[-1.857723,9.037451,-4.255881],[0.4795222,9.356807,-3.931844],[7.423672,5.12122,4.67989],[6.351075,-7.403396,-2.844774],[-1.338632,9.473326,3.421011],[4.212817,-7.161538,-5.848394],[5.513898,5.770205,6.28815],[-7.423765,-0.185751,6.934867],[-1.006516,9.5561,3.302583],[5.462786,3.126845,7.976213],[2.575088,-6.628334,7.257636],[9.564703,-0.3394527,-3.411803],[-7.622866,1.234933,6.603486],[-2.245022,9.021533,-4.100121],[1.857723,-9.037451,4.255881],[-0.4795222,-9.356807,3.931844],[-7.423672,-5.12122,-4.67989],[-6.351075,7.403396,2.844774],[1.338632,-9.473326,-3.421011],[-4.212817,7.161538,5.848394],[-5.513898,-5.770205,-6.28815],[7.423765,0.185751,-6.934867],[1.006516,-9.5561,-3.302583],[-5.462786,-3.126845,-7.976213],[-2.575088,6.628334,-7.257636],[-9.564703,0.3394527,3.411803]],"colors":[[0.4,0.4,0.4,1]],"texts":[["get along with conflicts"],["sociable"],["excluded"],["passive"],["indifferent"],["dispassionate"],["depressed"],["serious"],["selfish"],["peaceful"],["technical"],["emotional"],["extrovert"],["home oriented"],["balanced"],["isolated"],["closely integrated"],["discursive"],["open minded"],["dreamy"],["practically oriented"],["playful"],["socially minded"],["quarrelsome"],["artistic"],["scientific"],["introvert"],["wanderlust"]],"cex":[[0.6]],"adj":[[0.5,0.5]],"centers":[[7.622866,-1.234933,-6.603486],[2.245022,-9.021533,4.100121],[-1.857723,9.037451,-4.255881],[0.4795222,9.356807,-3.931844],[7.423672,5.12122,4.67989],[6.351075,-7.403396,-2.844774],[-1.338632,9.473326,3.421011],[4.212817,-7.161538,-5.848394],[5.513898,5.770205,6.28815],[-7.423765,-0.185751,6.934867],[-1.006516,9.5561,3.302583],[5.462786,3.126845,7.976213],[2.575088,-6.628334,7.257636],[9.564703,-0.3394527,-3.411803],[-7.622866,1.234933,6.603486],[-2.245022,9.021533,-4.100121],[1.857723,-9.037451,4.255881],[-0.4795222,-9.356807,3.931844],[-7.423672,-5.12122,-4.67989],[-6.351075,7.403396,2.844774],[1.338632,-9.473326,-3.421011],[-4.212817,7.161538,5.848394],[-5.513898,-5.770205,-6.28815],[7.423765,0.185751,-6.934867],[1.006516,-9.5561,-3.302583],[-5.462786,-3.126845,-7.976213],[-2.575088,6.628334,-7.257636],[-9.564703,0.3394527,3.411803]],"family":[["sans"]],"font":[[1]],"ignoreExtent":false,"flags":40},"14":{"id":14,"type":"linestrip","material":{"lit":false},"vertices":[[0,0,0],[10.16067,0,0]],"colors":[[0,0,0,1]],"centers":[[0,0,0],[10.16067,0,0]],"ignoreExtent":false,"flags":128},"15":{"id":15,"type":"linestrip","material":{"lit":false},"vertices":[[0,0,0],[0,10.16067,0]],"colors":[[0,0,0,1]],"centers":[[0,0,0],[0,10.16067,0]],"ignoreExtent":false,"flags":128},"16":{"id":16,"type":"linestrip","material":{"lit":false},"vertices":[[0,0,0],[0,0,10.16067]],"colors":[[0,0,0,1]],"centers":[[0,0,0],[0,0,10.16067]],"ignoreExtent":false,"flags":128},"17":{"id":17,"type":"text","material":{"lit":false},"vertices":[[10.16067,0,0]],"colors":[[0,0,0,1]],"texts":[["X"]],"cex":[[1.1]],"adj":[[1,1]],"centers":[[10.16067,0,0]],"family":[["sans"]],"font":[[1]],"ignoreExtent":false,"flags":40},"18":{"id":18,"type":"text","material":{"lit":false},"vertices":[[0,10.16067,0]],"colors":[[0,0,0,1]],"texts":[["Y"]],"cex":[[1.1]],"adj":[[1,1]],"centers":[[0,10.16067,0]],"family":[["sans"]],"font":[[1]],"ignoreExtent":false,"flags":40},"19":{"id":19,"type":"text","material":{"lit":false},"vertices":[[0,0,10.16067]],"colors":[[0,0,0,1]],"texts":[["Z"]],"cex":[[1.1]],"adj":[[1,1]],"centers":[[0,0,10.16067]],"family":[["sans"]],"font":[[1]],"ignoreExtent":false,"flags":40},"20":{"id":20,"type":"spheres","material":{},"vertices":[[0.386304,-0.06258269,-0.3346449],[0.1037138,-0.4167697,0.1894142],[-0.04420828,0.2150645,-0.1012773],[0.02152008,0.4199164,-0.176454],[0.33711,0.2325553,0.2125145],[0.2257524,-0.2631578,-0.101119],[-0.0309904,0.219315,0.07919913],[0.08821715,-0.1499639,-0.1224664],[0.2950906,0.3088075,0.3365267],[-0.4003765,-0.01001787,0.3740094],[-0.03401585,0.3229545,0.1116129],[0.3268435,0.187082,0.4772242],[0.1605406,-0.4132351,0.4524682],[0.5320792,-0.01888357,-0.1897967],[-0.386304,0.06258269,0.3346449],[-0.1037138,0.4167697,-0.1894142],[0.04420828,-0.2150645,0.1012773],[-0.02152008,-0.4199164,0.176454],[-0.33711,-0.2325553,-0.2125145],[-0.2257524,0.2631578,0.101119],[0.0309904,-0.219315,-0.07919913],[-0.08821715,0.1499639,0.1224664],[-0.2950906,-0.3088075,-0.3365267],[0.4003765,0.01001787,-0.3740094],[0.03401585,-0.3229545,-0.1116129],[-0.3268435,-0.187082,-0.4772242],[-0.1605406,0.4132351,-0.4524682],[-0.5320792,0.01888357,0.1897967]],"colors":[[0.4,0.4,0.4,1]],"radii":[[0.03907949]],"centers":[[0.386304,-0.06258269,-0.3346449],[0.1037138,-0.4167697,0.1894142],[-0.04420828,0.2150645,-0.1012773],[0.02152008,0.4199164,-0.176454],[0.33711,0.2325553,0.2125145],[0.2257524,-0.2631578,-0.101119],[-0.0309904,0.219315,0.07919913],[0.08821715,-0.1499639,-0.1224664],[0.2950906,0.3088075,0.3365267],[-0.4003765,-0.01001787,0.3740094],[-0.03401585,0.3229545,0.1116129],[0.3268435,0.187082,0.4772242],[0.1605406,-0.4132351,0.4524682],[0.5320792,-0.01888357,-0.1897967],[-0.386304,0.06258269,0.3346449],[-0.1037138,0.4167697,-0.1894142],[0.04420828,-0.2150645,0.1012773],[-0.02152008,-0.4199164,0.176454],[-0.33711,-0.2325553,-0.2125145],[-0.2257524,0.2631578,0.101119],[0.0309904,-0.219315,-0.07919913],[-0.08821715,0.1499639,0.1224664],[-0.2950906,-0.3088075,-0.3365267],[0.4003765,0.01001787,-0.3740094],[0.03401585,-0.3229545,-0.1116129],[-0.3268435,-0.187082,-0.4772242],[-0.1605406,0.4132351,-0.4524682],[-0.5320792,0.01888357,0.1897967]],"ignoreExtent":false,"flags":3},"21":{"id":21,"type":"spheres","material":{},"vertices":[[10.16067,0,0],[-10.16067,-0,-0],[0,10.16067,0],[-0,-10.16067,-0],[0,0,10.16067],[-0,-0,-10.16067]],"colors":[[1,1,1,1]],"radii":[[0]],"centers":[[10.16067,0,0],[-10.16067,-0,-0],[0,10.16067,0],[-0,-10.16067,-0],[0,0,10.16067],[-0,-0,-10.16067]],"ignoreExtent":false,"flags":3},"22":{"id":22,"type":"lines","material":{"lit":false},"vertices":[[10.16067,10.16067,10.16067],[-10.16067,10.16067,10.16067],[-10.16067,10.16067,10.16067],[-10.16067,-10.16067,10.16067],[-10.16067,-10.16067,10.16067],[10.16067,-10.16067,10.16067],[10.16067,-10.16067,10.16067],[10.16067,10.16067,10.16067],[10.16067,10.16067,-10.16067],[-10.16067,10.16067,-10.16067],[-10.16067,10.16067,-10.16067],[-10.16067,-10.16067,-10.16067],[-10.16067,-10.16067,-10.16067],[10.16067,-10.16067,-10.16067],[10.16067,-10.16067,-10.16067],[10.16067,10.16067,-10.16067],[10.16067,10.16067,10.16067],[10.16067,10.16067,-10.16067],[-10.16067,10.16067,10.16067],[-10.16067,10.16067,-10.16067],[-10.16067,-10.16067,10.16067],[-10.16067,-10.16067,-10.16067],[10.16067,-10.16067,10.16067],[10.16067,-10.16067,-10.16067]],"colors":[[0.6,0.6,0.6,1]],"centers":[[0,10.16067,10.16067],[-10.16067,0,10.16067],[0,-10.16067,10.16067],[10.16067,0,10.16067],[0,10.16067,-10.16067],[-10.16067,0,-10.16067],[0,-10.16067,-10.16067],[10.16067,0,-10.16067],[10.16067,10.16067,0],[-10.16067,10.16067,0],[-10.16067,-10.16067,0],[10.16067,-10.16067,0]],"ignoreExtent":false,"flags":128},"5":{"id":5,"type":"light","vertices":[[0,0,1]],"colors":[[1,1,1,1],[1,1,1,1],[1,1,1,1]],"viewpoint":true,"finite":false},"4":{"id":4,"type":"background","material":{"back":"filled"},"colors":[[0.2980392,0.2980392,0.2980392,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"6":{"id":6,"type":"background","material":{"lit":false,"fog":false},"colors":[[1,1,1,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"9":{"id":9,"type":"background","material":{},"colors":[[1,1,1,1]],"centers":[[0,0,0]],"sphere":false,"fogtype":"none","flags":0},"1":{"id":1,"type":"subscene","par3d":{"antialias":8,"FOV":60,"ignoreExtent":false,"listeners":1,"mouseMode":{"left":"trackball","right":"zoom","middle":"fov","wheel":"pull"},"observer":[0,0,35.19758],"modelMatrix":[[1,0,0,0],[0,1,0,0],[0,0,1,-35.19758],[0,0,0,1]],"projMatrix":[[2.309401,0,0,0],[0,2.309401,0,0],[0,0,-2,-52.79638],[0,0,-1,0]],"skipRedraw":false,"userMatrix":[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],"scale":[1,1,1],"viewport":{"x":0,"y":0,"width":1,"height":1},"zoom":0.75,"bbox":[-10.16067,10.16067,-10.16067,10.16067,-10.16067,10.16067],"windowRect":[100,100,484,484],"family":"sans","font":1,"cex":1,"useFreeType":false,"fontname":"TT Arial","maxClipPlanes":8},"embeddings":{"viewport":"replace","projection":"replace","model":"replace"},"objects":[9,10,11,12,13,14,15,16,17,18,19,20,21,22,5],"subscenes":[],"flags":1195}},"snapshot":"data:image/png;base64,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","width":385,"height":385,"sphereVerts":{"vb":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1950903,-0.3826834,-0.5555702,-0.7071068,-0.8314696,-0.9238795,-0.9807853,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1],[0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1950903,-0.3826834,-0.5555702,-0.7071068,-0.8314696,-0.9238795,-0.9807853,-1,-0.9807853,-0.9238795,-0.8314696,-0.7071068,-0.5555702,-0.3826834,-0.1950903,-0,-0,-0.18024,-0.3535534,-0.51328,-0.6532815,-0.7681778,-0.8535534,-0.9061274,-0.9238795,-0.9061274,-0.8535534,-0.7681778,-0.6532815,-0.51328,-0.3535534,-0.18024,-0,-0,-0.1379497,-0.2705981,-0.3928475,-0.5,-0.5879378,-0.6532815,-0.6935199,-0.7071068,-0.6935199,-0.6532815,-0.5879378,-0.5,-0.3928475,-0.2705981,-0.1379497,-0,-0,-0.07465783,-0.1464466,-0.2126075,-0.2705981,-0.3181896,-0.3535534,-0.3753303,-0.3826834,-0.3753303,-0.3535534,-0.3181896,-0.2705981,-0.2126075,-0.1464466,-0.07465783,-0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.07465783,0.1464466,0.2126075,0.2705981,0.3181896,0.3535534,0.3753303,0.3826834,0.3753303,0.3535534,0.3181896,0.2705981,0.2126075,0.1464466,0.07465783,0,0,0.1379497,0.2705981,0.3928475,0.5,0.5879378,0.6532815,0.6935199,0.7071068,0.6935199,0.6532815,0.5879378,0.5,0.3928475,0.2705981,0.1379497,0,0,0.18024,0.3535534,0.51328,0.6532815,0.7681778,0.8535534,0.9061274,0.9238795,0.9061274,0.8535534,0.7681778,0.6532815,0.51328,0.3535534,0.18024,0,0,0.1950903,0.3826834,0.5555702,0.7071068,0.8314696,0.9238795,0.9807853,1,0.9807853,0.9238795,0.8314696,0.7071068,0.5555702,0.3826834,0.1950903,0]],"it":[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270],[17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288],[18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271]],"primitivetype":"triangle","material":null,"normals":null,"texcoords":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.0625,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.1875,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.25,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.3125,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.4375,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.5625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.625,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.6875,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.8125,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.875,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,0.9375,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1,0,0.0625,0.125,0.1875,0.25,0.3125,0.375,0.4375,0.5,0.5625,0.625,0.6875,0.75,0.8125,0.875,0.9375,1]]}});
biplot3rgl.prefix = "biplot3";
</script>
<p id="biplot3debug">
You must enable Javascript to view this page properly.
</p>
<script>biplot3rgl.start();</script>
</div>
</div>
<div id="pre-transformations" class="section level3">
<h3>Pre-transformations</h3>
<p>When representing grid data a decision has to be made whether to apply pre-transformations to the data before submitting it to the SVD. These transformations include the <strong>centering</strong> and the <strong>normalization</strong> of the data. In the INGRID procedure (Slater, 1977) the centering of the constructs, i.e. removing the mean value of each row, is used as a default option. Other theorists argue that “double-centering” (i.e. by row and column means) (e.g. Hope, 1966) or that midpoint centering is appropriate to analyze grid data (Raeithel, 1998). The question if or not and which kind of pre-treatment is to be applied has no definite answer and will not be followed here. Note however that different options in pre-treatment results in different spatial representations. Hence, the researcher has to be aware of the influence the pre-treatment exerts onto the spatial representation.</p>
<p>In OpenRepGrid different options for centering and normalization (also called scaling) are included. The <strong>centering</strong> option for rows and columns of a matrix in yields four possible combinations: 1) construct centering, 2) element centering, 3) double-centering and 4) construct midpoint centering. The last option is also denoted “double-centering” of a grid. For normalization three options can be chosen: 0) no normalization, 1) normalization of constructs and 2) normalization of elements. A simultaneous normalization of rows and columns is not possible.</p>
<p>If the output is affected by pre-scaling the corresponding function in OpenRepGrid offers an argument to specify the form of pre-scaling to be used. The following figures demonstrate how different forms of pre-scaling lead to different representation.</p>
<pre class="r"><code>biplot2d(boeker, center=1, normalize=0)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biplot2d-transforms-1-1.png" width="672" /></p>
<pre class="r"><code>biplot2d(boeker, center=2, normalize=0)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biplot2d-transforms-2-1.png" width="672" /></p>
<pre class="r"><code>biplot2d(boeker, center=1, normalize=2)</code></pre>
<p><img src="visualization-biplot_files/figure-html/biplot2d-transforms-3-1.png" width="672" /></p>
</div>
<div id="standard-biplot-types" class="section level3">
<h3>Standard biplot types</h3>
<p>The type of biplot that is produced depends on the way the singular values are assigned to the elements and constructs matrices (see calculation of a biplot). Two parameters steer the assignment: <span class="math inline">\(g\)</span> and <span class="math inline">\(h\)</span>. Depending on the choice of these parameters and the form of pre-transformations used, different types of biplots are plotted. The following three biplots represent the three most important ones.</p>
<div id="element-metric-preserving-biplot" class="section level4">
<h4>Element metric preserving biplot</h4>
<p>The standard biplot function preserves the distances between the elements, i.e. a form biplot.</p>
<pre class="r"><code>biplot2d(boeker)
biplotPseudo3d(boeker)
biplot3d(boeker)</code></pre>
</div>
<div id="slaters-ingrid-biplot" class="section level4">
<h4>Slater’s INGRID biplot</h4>
<p>The first version of a joint spatial representation of elements and constructs has become known as Slater’s INGRID biplot. The default is to use row centering and no normalization. Note that Slater’s biplot is just a special case of a biplot that can be produced using the <code>biplot2d</code> function with the arguments <code>center=1</code>, <code>g=1</code>, <code>h=1</code>. The arguments that can be used in this function are the same as in <code>biplot2d</code>.</p>
<pre class="r"><code>biplotSlater2d(boeker)
biplot2d(boeker, center=1, g=1, h=1)      # compare to previous plot

biplotSlaterPseudo3d(boeker)
biplotSlater3d(boeker)</code></pre>
</div>
<div id="eigenstructure-analysis-esa-biplot" class="section level4">
<h4>Eigenstructure analysis (ESA) biplot</h4>
<p>The ESA is a special type of biplot suggested by Raeithel (e.g. 1998). It uses midpoint centering as a default. Note that the eigenstructure analysis is just a special case of a biplot that can also be produced using the <code>biplot2d</code> function with the arguments <code>center=4</code>, <code>g=1</code>, <code>h=1</code>.</p>
<pre class="r"><code>biplotEsa2d(boeker)
biplot2d(boeker, center=1, g=1, h=1)      # compare to previous plot

biplotEsaPseudo3d(boeker)
biplotEsa3d(boeker)</code></pre>
</div>
</div>
<div id="changing-the-appearance" class="section level3">
<h3>Changing the appearance</h3>
<p>A lot of arguments affecting the appearance of the biplot can be changed. For a full list see biplot2d. The following codes correspond to the figures in the gallery below. It gives an impression of what can be changed in <code>biplot2d</code>. Most arguments also apply to the other biplot functions (see above).</p>
<pre class="r"><code>biplot2d(boeker, e.label.col=&quot;red&quot;, c.label.col=&quot;blue&quot;)   # plot1: change label colors
biplot2d(boeker, e.point.col=&quot;red&quot;, c.point.col=&quot;blue&quot;)   # plot2: change symbol colors

biplot2d(boeker, e.label.cex=1, c.label.cex=.5)           # plot3: change label size
biplot2d(boeker, e.point.cex=1.5, c.point.cex=.5)         # plot4 :change symbol size

biplot2d(boeker, zoom=.5)                                 # plot5: zoom out
biplot2d(boeker, zoom=2.5)                                # plot6: zoom in

biplot2d(boeker, unity=T)                                 # plot7: scale construct &amp; element vectors to equal length
biplot2d(boeker, unity=T, scale.e=.5)                     # plot8: scaling factor for element vectors

biplot2d(boeker, e.labels.show=F)                         # plot9: do not show element labels
biplot2d(boeker, e.labels.show=c(1,2,4))                  # plot10: show labels for elements 1, 2 and 4
biplot2d(boeker, e.points.show=c(1,2,4))                  # plot11: only show elements 1, 2 and 4
biplot2d(boeker, c.labels.show=1:4)                       # plot12: show constructs labels 1 to 4   

biplot2d(boeker, g=1, h=1, c.labels.inside=T,             # plot13: different margins and element color 
         mai=c(0,0,0,0), e.label.col=&quot;blue&quot;) 

biplot2d(boeker, flipaxes=c(T, F))                        # plot14: flip x axis

biplot2d(boeker, outer.positioning=F)                     # plot15: no positioning of construct labels
biplot2d(boeker, c.labels.devangle=20)                    # plot16: only show constructs within 20 degree angle from xy plane</code></pre>
</div>
<div id="calculation-of-biplots" class="section level3">
<h3>Calculation of biplots</h3>
<p>The central concept is to factorize the data matrix <span class="math inline">\(X\)</span> into two matrices <span class="math inline">\(G\)</span> and <span class="math inline">\(H\)</span> such that</p>
<p><span class="math display">\[ X = GH^T.\]</span></p>
<p>Hence, the scalar product between a row vector of <span class="math inline">\(G\)</span> and a column vector of <span class="math inline">\(H\)</span> will reproduce the original cell value of a matrix. The scalar product has a geometrical interpretation as the projection of one vector onto the other. As the data matrix <span class="math inline">\(X\)</span> usually has a rank higher than two, a representation in two (or three) dimensions requires to find an optimal representation within a lower dimensional space. To find a low dimension representation the singular value decomposition is applied. It factorizes <span class="math inline">\(X\)</span> into three matrices: <span class="math inline">\(U\)</span> containing the row vectors, <span class="math inline">\(V\)</span> the column points and <span class="math inline">\(D\)</span> the singular values (root of eigenvalues) of the new principal axes.</p>
<p><span class="math display">\[ X = UDV^T \]</span></p>
<p>Eckart and Young (1936) showed that the SVD has the property to yield the best lower rank approximation of <span class="math inline">\(X\)</span> based on. Hence, a lower dimensional representation (e.g. in two dimensions) that is optimal in a least-square sense can be written as</p>
<p><span class="math display">\[ X_{[2]} = U_{[2]} D_{[2]} V_{[2]}^T \]</span></p>
<p>This representation almost already has the form required for a biplot representation. The decision to take is how to assign the singular values to the left and right matrices.</p>
<p><span class="math display">\[ X = UD^g D^h V^T X = GH^T \]</span></p>
<p>In the standard biplot <span class="math inline">\(g=0\)</span> and <span class="math inline">\(h=1\)</span>. This yields a so called <em>form biplot</em>, as the metric of the elements is preserved. Several other standard representations can be expressed in terms of the parameters <span class="math inline">\(g\)</span>, <span class="math inline">\(h\)</span> and the pre-transformations (centering, normalization) applied to <span class="math inline">\(X\)</span>.</p>
</div>
<div id="literature" class="section level3">
<h3>Literature</h3>
<ul>
<li>Fransella, F., Bell, R. C., &amp; Bannister, D. (2003). A Manual for Repertory Grid Technique (2. ed.). Chichester: John Wiley &amp; Sons.</li>
<li>Gower, J., Lubbe, S. G., Gardner, S., &amp; Roux, N. L. (2011). Understanding Biplots. John Wiley and Sons.</li>
<li>Greenacre, M. (2010). Biplots in practice. Madrid: BBVA Foundation. Retrieved from <a href="http://www.multivariatestatistics.org/biplots.html" class="uri">http://www.multivariatestatistics.org/biplots.html</a></li>
<li>Hope, K. (1966). Cos and Cosmos: Considerations on Patrick Slater’s Monograph The Principal Components of a Repertory Grid. British Journal of Psychiatry, 66(112), 1155 - 1163.</li>
<li>Raeithel, A. (1998). Kooperative Modellproduktion von Professionellen und Klienten – erläutert am Beispiel des Repertory Grid. In Selbstorganisation, Kooperation, Zeichenprozeß : Arbeiten zu einer kulturwissenschaftlichen, anwendungsbezogenen Psychologie (pp. 209-254). Opladen: Westdeutscher Verlag.</li>
<li>Slater, P. (1964). The Principal Components of a Repertory. London: Vincent Andrews &amp; Co.</li>
<li>Slater, P. (1977). The measurement of intrapersonal space by Grid technique. London: Wiley.</li>
</ul>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
